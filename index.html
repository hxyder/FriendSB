<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç‰›é€¼äººåˆ†ç‰›é€¼é’±Â·ï¼ˆ6ä½å£ä»¤åŠ å¯†ï¼‰</title>
  <style>
  :root{
    --bg:#f6f7ff;
    --card:#ffffff;
    --text:#12162a;
    --muted:#5b6b96;
    --line:rgba(18,22,42,.10);

    /* Brand accents */
    --pri:#3b5cff;     /* blue */
    --pri2:#b24bff;    /* purple */
    --cyan:#12c2ff;    /* cyan */
    --orange:#ff9f2f;  /* orange */
    --green:#14b86a;   /* green */
    --pink:#ff3b7a;    /* pink */

    --good:#14b86a;
    --bad:#ff3b7a;

    --shadow:0 12px 28px rgba(18,22,42,.12);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial;
    color:var(--text);
    background:
      radial-gradient(1100px 700px at 12% -6%, rgba(59,92,255,.24), transparent 60%),
      radial-gradient(900px 650px at 98% 4%, rgba(178,75,255,.20), transparent 60%),
      radial-gradient(900px 650px at 45% 110%, rgba(18,194,255,.14), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.80), rgba(246,247,255,1)),
      var(--bg);
  }

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.82);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .top{
    max-width:1100px; margin:0 auto; padding:12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .title{font-weight:950}
  .sub{font-size:12px; color:var(--muted); margin-top:4px}
  .rightTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

  .badge{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(59,92,255,.22);
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
    color:#1b2140;
    white-space:nowrap;
  }

  .wrap{max-width:1100px; margin:0 auto; padding:14px 14px 96px}
  .grid{display:grid; gap:12px}
  @media(min-width:980px){ .grid{grid-template-columns: 360px 1fr;} }

  .card{
    background:var(--card);
    border:1px solid rgba(18,22,42,.10);
    border-radius:18px;
    padding:12px;
    box-shadow:var(--shadow);
  }

  h2{margin:0 0 10px; font-size:14px; color:#1b2140}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .hr{height:1px; background:var(--line); margin:12px 0}

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid rgba(18,22,42,.10);
    background: rgba(255,255,255,.92);
  }
  th, td{
    padding:10px 10px;
    border-bottom:1px solid rgba(18,22,42,.08);
    font-size:12px;
    text-align:left;
    vertical-align:top;
  }
  th{
    color:#1b2140;
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
  }
  tbody tr:nth-child(even){ background: rgba(59,92,255,.03); }
  .right{text-align:right}
  .ok{color:var(--good); font-weight:950}
  .no{color:var(--bad); font-weight:950}

  .pills{display:flex; flex-wrap:wrap; gap:8px}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid rgba(59,92,255,.18);
    background: linear-gradient(90deg, rgba(59,92,255,.08), rgba(18,194,255,.06));
    font-size:12px;
  }
  .pill b{font-weight:950}
  .pill .x{cursor:pointer; opacity:.75}
  .pill .x:hover{opacity:1}

  /* ===== Buttons base + interaction ===== */
  button{
    border:none;
    cursor:pointer;
    color:white;
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    background: linear-gradient(90deg, rgba(59,92,255,.98), rgba(178,75,255,.96));
    box-shadow: 0 10px 22px rgba(59,92,255,.22);
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  button:hover{
    filter: brightness(1.04);
    box-shadow: 0 12px 26px rgba(59,92,255,.26);
  }
  button:active{
    transform: translateY(1px);
    filter: brightness(.98);
  }

  /* Secondary: light but still colorful */
  button.secondary{
    color:var(--text);
    background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
    border:1px solid rgba(18,22,42,.12);
    font-weight:900;
    box-shadow: 0 10px 22px rgba(18,22,42,.06);
  }
  button.secondary:hover{
    box-shadow: 0 12px 26px rgba(18,22,42,.08);
  }

  /* Ghost: subtle colored outline on hover */
  button.ghost{
    color:var(--text);
    background: rgba(255,255,255,.55);
    border:1px solid rgba(18,22,42,.14);
    font-weight:900;
    box-shadow:none;
  }
  button.ghost:hover{
    background: rgba(59,92,255,.08);
    border-color: rgba(59,92,255,.28);
  }

  /* Danger: vivid */
  button.danger{
    color:white;
    background: linear-gradient(90deg, rgba(255,59,122,.98), rgba(255,159,47,.92));
    border:none;
    font-weight:950;
    box-shadow: 0 10px 22px rgba(255,59,122,.18);
  }
  button.danger:hover{
    box-shadow: 0 12px 26px rgba(255,59,122,.22);
  }

  /* Bottom bar */
  .bottomBar{
    position:fixed; left:0; right:0; bottom:0; z-index:20;
    background:rgba(255,255,255,.90);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(18,22,42,.10);
  }
  .bottomInner{
    max-width:1100px; margin:0 auto;
    padding:10px 12px;
    display:flex; gap:10px;
  }
  .bottomInner button{
    flex:1;
    padding:12px 10px;
    border-radius:16px;
  }
  /* ===== Action buttons per bill ===== */
  button[data-act="toggle"]{
    background: linear-gradient(90deg, rgba(18,194,255,.95), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(18,194,255,.18);
    color:white;
    border:none;
  }
  button[data-act="edit"]{
    background: linear-gradient(90deg, rgba(59,92,255,.95), rgba(178,75,255,.92));
    box-shadow: 0 10px 22px rgba(178,75,255,.16);
    color:white;
    border:none;
  }
  button[data-act="dup"]{
    background: linear-gradient(90deg, rgba(255,159,47,.92), rgba(255,59,122,.88));
    box-shadow: 0 10px 22px rgba(255,159,47,.14);
    color:white;
    border:none;
  }
  button[data-act="setAll"]{
    background: linear-gradient(90deg, rgba(20,184,106,.90), rgba(18,194,255,.86));
    box-shadow: 0 10px 22px rgba(20,184,106,.14);
    color:white;
    border:none;
  }

  /* ===== Function-colored buttons (no new classes needed) =====
     By targeting your existing bottom buttons order:
     1) +äºº  2) +è´¦  3) åä½œ  4) å¯¼å‡º
  */
  .bottomInner button:nth-child(1){
    background: linear-gradient(90deg, rgba(18,194,255,.98), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(18,194,255,.20);
    color:white;
  }
  .bottomInner button:nth-child(2){
    background: linear-gradient(90deg, rgba(178,75,255,.98), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(178,75,255,.20);
    color:white;
  }
  .bottomInner button:nth-child(3){
    /* your 3rd is secondary now, make it still colorful */
    background: linear-gradient(90deg, rgba(255,159,47,.18), rgba(255,255,255,.86));
    border:1px solid rgba(255,159,47,.30);
    color: #1b2140;
    box-shadow: 0 10px 22px rgba(255,159,47,.10);
  }
  .bottomInner button:nth-child(4){
    background: linear-gradient(90deg, rgba(20,184,106,.18), rgba(255,255,255,.86));
    border:1px solid rgba(20,184,106,.28);
    color: #1b2140;
    box-shadow: 0 10px 22px rgba(20,184,106,.10);
  }
  .bottomInner button:nth-child(5){
    background: linear-gradient(90deg, rgba(255,59,122,.18), rgba(255,255,255,.86));
    border:1px solid rgba(255,59,122,.30);
    color:#1b2140;
    box-shadow: 0 10px 22px rgba(255,59,122,.10);
  }

  /* Modal center */
  .modalMask{
    position:fixed; inset:0; z-index:30;
    background: rgba(18,22,42,.35);
    display:none; align-items:center; justify-content:center;
    padding:14px;
  }
  .modal{
    width:min(720px, 100%);
    max-height: 86vh;
    overflow:auto;
    background: rgba(255,255,255,.92);
    border:1px solid rgba(18,22,42,.10);
    border-radius:18px;
    box-shadow: 0 24px 60px rgba(18,22,42,.22);
  }
  .modalHeader{
    padding:12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom:1px solid rgba(18,22,42,.10);
    position:sticky; top:0;
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(8px);
  }
  .modalTitle{font-weight:950}
  .modalBody{padding:12px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  label{font-size:12px; color:var(--muted)}
  input, select, textarea{
    border-radius:14px; border:1px solid rgba(18,22,42,.12);
    background: rgba(255,255,255,.98);
    color:var(--text);
    padding:11px 10px;
    outline:none;
    width:100%;
    transition: box-shadow .12s ease, border-color .12s ease;
  }
  input:focus, select:focus, textarea:focus{
    border-color: rgba(59,92,255,.45);
    box-shadow: 0 0 0 4px rgba(59,92,255,.12);
  }
  input[type="date"]{max-width:240px}
  input[type="number"]{max-width:240px}
  .col2{display:grid; gap:10px}
  @media(min-width:640px){ .col2{grid-template-columns:1fr 1fr;} }

  .checkList{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px}
  @media(min-width:640px){ .checkList{grid-template-columns:1fr 1fr;} }
  .checkItem{
    display:flex; align-items:center; gap:10px;
    padding:10px; border-radius:14px;
    border:1px solid rgba(59,92,255,.16);
    background: linear-gradient(90deg, rgba(59,92,255,.08), rgba(18,194,255,.06));
  }
  .checkItem input{width:auto}
  .hint{font-size:12px; color:var(--muted); line-height:1.6}

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:86px; z-index:50;
    background:rgba(18,22,42,.92);
    color:white;
    border:1px solid rgba(255,255,255,.22);
    padding:10px 12px;
    border-radius:999px;
    display:none;
    font-size:12px;
    max-width:min(92vw, 560px);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(18,22,42,.06);
    border:1px solid rgba(18,22,42,.10);
  }

  /* ===== Bill collapse + prettier table ===== */
  .bill-topline{
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-start;
  }
  .bill-actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .bill-toggle{
    padding:8px 10px;
    border-radius:999px;
  }
  .bill-body{ margin-top:10px; display:none; }
  .bill-body.open{ display:block; }

  .bill-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid rgba(18,22,42,.10);
    background:rgba(255,255,255,.95);
  }
  .bill-table thead th{
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
    border-bottom:1px solid rgba(18,22,42,.10);
  }
  .bill-table th, .bill-table td{ padding:10px 10px; font-size:12px; }
  .bill-table tbody tr:nth-child(even){ background: rgba(59,92,255,.03); }

  .bill-days-input{
    width:100px;
    text-align:right;
    border-radius:12px;
    padding:9px 10px;
  }
  .bill-suggest{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }
  /* ===== Bill card accent ===== */
  .billCard{
    position:relative;
    overflow:hidden;
  }
  .billCard::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width:6px;
    background: linear-gradient(180deg, var(--accent1), var(--accent2));
    opacity:.95;
  }
  .billCardHeaderGlow{
    background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0)),
                linear-gradient(90deg, color-mix(in srgb, var(--accent1) 14%, transparent),
                                     color-mix(in srgb, var(--accent2) 10%, transparent));
    border-radius:14px;
    padding:10px;
  }

  /* ===== Tabs for è´¦å•/æ±‡æ€»/ç»“ç®— ===== */
  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabBtn{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(18,22,42,.14);
    background: rgba(255,255,255,.85);
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow:none;
    transition: background .12s ease, border-color .12s ease;
  }
  .tabBtn:hover{
    background: rgba(59,92,255,.08);
    border-color: rgba(59,92,255,.28);
  }
  .tabBtn.active{
    border-color: rgba(59,92,255,.35);
    background: linear-gradient(90deg, rgba(59,92,255,.14), rgba(178,75,255,.10));
  }
  .tabPanel{ display:none; }
  .tabPanel.active{ display:block; }
  /* ===== AI chat bubbles ===== */
  .ai-bubble{
    max-width: 92%;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,.92);
    box-shadow: 0 10px 22px rgba(18,22,42,.10);
    line-height: 1.55;
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .ai-user{ align-self:flex-end; background: rgba(75,107,255,.12); border-color: rgba(75,107,255,.25); }
  .ai-assistant{ align-self:flex-start; background: rgba(162,75,255,.10); border-color: rgba(162,75,255,.22); }
      
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
// å…¨å±€å˜é‡ï¼Œç”¨äºè°ƒè¯•
window.debugState = () => console.log('Current state:', state);
window.debugInvoices = () => console.log('Invoice drafts:', invoiceDrafts);
</script>
</head>

<body>
<header>
  <div class="top">
    <div>
      <div class="title">ç‰›é€¼äººåˆ†ç‰›é€¼é’±Â· çœŸåä½œï¼ˆ6ä½å£ä»¤åŠ å¯†ï¼‰</div>
      <div class="sub">é‚€è¯·é“¾æ¥å¸¦ room Â· è®°å¾—è®¾ç½®å¯†ç </div>
    </div>
    <div class="rightTop">
      <div class="badge" id="syncBadge">ç¦»çº¿ï¼šä»…æœ¬æœºä¿å­˜</div>
      <button class="secondary" onclick="openModal('share')">é‚€è¯· / åˆ†äº«</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>äººå‘˜</h2>
      <div class="pills" id="peoplePills"></div>

      <div class="hr"></div>

      <h2>å·¥å…·</h2>
      <div class="row">
        <button class="secondary" onclick="openModal('person')">æ·»åŠ äººå‘˜</button>
        <button class="secondary" onclick="openModal('bill')">æ·»åŠ è´¦å•</button>
        <button class="secondary" onclick="exportJSON()">å¯¼å‡º</button>
      </div>

      <div class="hr"></div>

      <h2>è¯´æ˜</h2>
      <div class="hint">
        - äº‘ç«¯å­˜çš„æ˜¯<strong>åŠ å¯†åçš„å¯†æ–‡</strong>ï¼šæ²¡ 6 ä½å£ä»¤çœ‹ä¸åˆ°é‡‘é¢ã€‚<br/>
        - å†™å…¥éœ€è¦å£ä»¤æ ¡éªŒï¼ˆRules æ¯”å¯¹ passHashï¼‰ï¼Œé˜²æ­¢åˆ«äººç¯¡æ”¹ã€‚<br/>
        - é“¾æ¥é‡Œå¸¦ <span class="kbd">?room=xxxx</span>ï¼Œæˆ¿é—´å·ä¼šè‡ªåŠ¨å¡«å…¥åŠ å…¥æ¡†ã€‚<br/>
        - å¦‚æœéœ€è¦å¯åŠ¨AIï¼Œåˆ°é¡¶éƒ¨çš„åä½œ/åˆ†äº«é‡Œè¾“å…¥å¯†é’¥ã€‚
      </div>
    </div>

    <div class="card">
    
      <!-- Tabs -->
      <div class="tabs" id="mainTabs">
        <button class="tabBtn" data-tab="bills">è´¦å•åˆ—è¡¨</button>
        <button class="tabBtn" data-tab="summary">æ¯äººæ±‡æ€»</button>
        <button class="tabBtn" data-tab="settle">æœ€ç»ˆç»“ç®—</button>
      </div>
    
      <!-- Panel: Bills -->
      <div class="tabPanel" id="panelBills">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">è´¦å•åˆ—è¡¨</h2>
          <div class="row" style="gap:8px">
            <button class="secondary ghost" id="btnBillsCompact">æŠ˜å åˆ—è¡¨</button>
            <button class="secondary ghost" id="btnBillsExpand">å±•å¼€åˆ—è¡¨</button>
          </div>
        </div>
        <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.75); margin-top:10px">
          <div class="col2">
            <div>
              <label>ç­›é€‰ä»˜æ¬¾äºº</label>
              <select id="filterPayer"></select>
            </div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button class="secondary" id="btnFilterClear">æ¸…ç©ºç­›é€‰</button>
            </div>
            <div>
              <label>å¼€å§‹æ—¥æœŸï¼ˆå¯ä¸å¡«ï¼‰</label>
              <input id="filterFrom" type="date" />
            </div>
            <div>
              <label>ç»“æŸæ—¥æœŸï¼ˆå¯ä¸å¡«ï¼‰</label>
              <input id="filterTo" type="date" />
            </div>
          </div>
          <div class="hint" style="margin-top:8px">
            æ—¥æœŸç­›é€‰æŒ‰â€œä¸è´¦å•æ—¥æœŸåŒºé—´æœ‰äº¤é›†â€åˆ¤æ–­ï¼ˆæ›´ç¬¦åˆè·¨å¤©è´¦å•ï¼‰ã€‚
          </div>
        </div>        
        <div id="billsContainer"></div>
      </div>
    
      <!-- Panel: Summary -->
      <div class="tabPanel" id="panelSummary">
        <h2>æ¯äººæ±‡æ€»ï¼ˆåº”ä»˜/å®ä»˜/å‡€é¢ï¼‰</h2>
        <table>
          <thead>
            <tr>
              <th>äººå‘˜</th>
              <th class="right">åº”ä»˜</th>
              <th class="right">å®ä»˜</th>
              <th class="right">å‡€é¢</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </div>
    
      <!-- Panel: Settlement -->
      <div class="tabPanel" id="panelSettle">
        <h2>æœ€ç»ˆç»“ç®—ï¼ˆæŠµæ¶ˆåæœ€å°‘è½¬è´¦ï¼‰</h2>
        <table>
          <thead>
            <tr>
              <th>ä»˜æ¬¾äºº</th>
              <th>æ”¶æ¬¾äºº</th>
              <th class="right">é‡‘é¢</th>
            </tr>
          </thead>
          <tbody id="settleBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="bottomBar">
  <div class="bottomInner">
    <button onclick="openModal('person')">+ äºº</button>
    <button onclick="openModal('bill')">+ è´¦</button>
    <button class="secondary" onclick="openModal('share')">åä½œ</button>
    <button class="secondary" onclick="exportJSON()">å¯¼å‡º</button>
    <button class="secondary" onclick="openAiEntry()">AI</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Modal: Add Person -->
<div class="modalMask" id="modalPerson">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">æ·»åŠ äººå‘˜</div>
      <button class="ghost" onclick="closeModal('person')">å…³é—­</button>
    </div>
    <div class="modalBody">
    <!-- âœ… æ–°å¢ï¼šè´¦å•è‰ç¨¿é˜Ÿåˆ—åˆ†é¡µæ¡ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <div id="billDraftBar" style="display:none; margin-bottom:10px">
        <div class="card" style="box-shadow:none;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.75)">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div style="font-weight:950">æ¥è‡ªå‘ç¥¨ï¼š<span id="billDraftPos">1/1</span></div>
            <div class="row" style="gap:8px">
              <button class="secondary" id="btnBillDraftPrev" type="button">ä¸Šä¸€å¼ </button>
              <button class="secondary" id="btnBillDraftNext" type="button">ä¸‹ä¸€å¼ </button>
              <button class="danger ghost" id="btnBillDraftRemove" type="button">ç§»é™¤è‰ç¨¿</button>
            </div>
          </div>
          <div class="hint" style="margin-top:8px">æç¤ºï¼šæ¯å¼ å‘ç¥¨â€œåº”ç”¨åˆ°è´¦å•â€åä¼šç”Ÿæˆä¸€ä¸ªè‰ç¨¿ï¼Œä½ å¯ä»¥åˆ†é¡µç¼–è¾‘å¹¶é€ä¸ªåˆ›å»ºã€‚</div>
        </div>
      </div>      
      <label>å§“å</label>
      <input id="personName" placeholder="ä¾‹å¦‚ï¼šA / B / C" />
      <div class="row" style="margin-top:12px">
        <button onclick="addPerson()">æ·»åŠ </button>
        <button class="secondary" onclick="closeModal('person')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Bill -->
<div class="modalMask" id="modalBill">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">æ·»åŠ è´¦å•</div>
      <button class="ghost" onclick="closeModal('bill')">å…³é—­</button>
    </div>
    <div class="modalBody">
      <div class="col2">
        <div>
          <label>è´¦å•åç§°</label>
          <input id="billTitle" placeholder="ä¾‹å¦‚ï¼šæˆ¿ç§Ÿ / æ°´ç”µ / ç½‘è´¹" />
        </div>
        <div>
          <label>é‡‘é¢ï¼ˆæ€»é¢ï¼‰</label>
          <input id="billAmount" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š1200" />
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="card" style="box-shadow:none;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.75)">
            <div style="font-weight:950;margin-bottom:8px">å°è´¹ï¼ˆ0% ~ 25%ï¼‰</div>
        
            <div class="col2">
              <div>
                <label>å°ç¥¨å°è®¡ Subtotalï¼ˆä¸å«å°è´¹ï¼‰</label>
                <input id="billSubtotal" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š100.00" />
                <div class="hint">å¡«å†™å°è®¡åï¼Œå°è´¹ä¼šè‡ªåŠ¨ç®—è¿›â€œé‡‘é¢ï¼ˆæ€»é¢ï¼‰â€ã€‚</div>
              </div>
        
              <div>
                <label>é€‰æ‹©å°è´¹æ¯”ä¾‹</label>
                <div class="row" style="gap:10px; flex-wrap:wrap">
                  <label class="pill"><input type="radio" name="tipPreset" value="0" checked> 0%</label>
                  <label class="pill"><input type="radio" name="tipPreset" value="18"> 18%</label>
                  <label class="pill"><input type="radio" name="tipPreset" value="20"> 20%</label>
                  <label class="pill"><input type="radio" name="tipPreset" value="25"> 25%</label>
                  <label class="pill"><input type="radio" name="tipPreset" value="other"> å…¶ä»–</label>
                </div>
        
                <div class="row" style="margin-top:8px; align-items:center">
                  <input id="billTipOther" type="number" min="0" max="25" step="0.1" placeholder="0~25" style="max-width:140px" disabled />
                  <div class="hint">é€‰â€œå…¶ä»–â€åè¾“å…¥æ¯”ä¾‹ï¼ˆ%ï¼‰ã€‚</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        
        <div>
          <label>å¼€å§‹æ—¥æœŸ</label>
          <input id="billStart" type="date" />
        </div>
        <div>
          <label>ç»“æŸæ—¥æœŸï¼ˆå«å½“æ—¥ï¼‰</label>
          <input id="billEnd" type="date" />
        </div>
        <div>
          <label>ä»˜æ¬¾äººï¼ˆè°å«ä»˜ï¼‰</label>
          <select id="billPayer"></select>
        </div>
        <div>
          <label>è´¦å•å¤©æ•°ï¼ˆè‡ªåŠ¨ï¼‰</label>
          <input id="billDays" disabled />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>å‚ä¸äººï¼ˆæ‰‹æœºå‹¾é€‰ï¼‰</label>
        <div class="checkList" id="billParticipantsChecks"></div>
        <div class="hint" style="margin-top:8px">
          åˆ›å»ºåé»˜è®¤æ¯äººå‚ä¸å¤©æ•°=è´¦å•å¤©æ•°ï¼›å¯åœ¨è´¦å•å¡ç‰‡é‡Œæ”¹å‚ä¸å¤©æ•°ã€‚
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="billSaveBtn" onclick="createBill()">åˆ›å»º</button>
      
        <!-- âœ… æ–°å¢ï¼šæ‰«æå‘ç¥¨ -->
        <button class="secondary" onclick="scanInvoices()">ğŸ§¾ æ‰«æå‘ç¥¨</button>
      
        <button class="secondary" onclick="closeModal('bill')">å–æ¶ˆ</button>
      </div>
      
      <!-- âœ… æ–°å¢ï¼šéšè—çš„å¤šé€‰æ–‡ä»¶è¾“å…¥ -->
      <input id="invoiceFiles" type="file" accept="image/*" multiple style="display:none" />
      
      <!-- âœ… æ–°å¢ï¼šè¯†åˆ«é˜Ÿåˆ—ï¼ˆæ”¾åœ¨ modalBill é‡Œä»»æ„ä½ç½®éƒ½è¡Œï¼Œå»ºè®®ç´§è·ŸæŒ‰é’®è¡Œåé¢ï¼‰ -->
      <div id="invoiceQueueBox" style="margin-top:12px; display:none"></div>

    </div>
  </div>
</div>
<!-- Modal: Invoice Scanner -->
<div class="modalMask" id="modalInvoice">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">æ‰«æå‘ç¥¨ï¼ˆå¤šå¼ ç¿»é¡µç¼–è¾‘ï¼‰</div>
      <button class="ghost" onclick="closeModal('invoice')">å…³é—­</button>
    </div>

    <div class="modalBody">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="hint">
          - å¯å¤šé€‰å›¾ç‰‡ï¼Œè¯†åˆ«åç”¨â€œä¸Šä¸€å¼ /ä¸‹ä¸€å¼ â€ç¿»é¡µç¼–è¾‘<br/>
          - ç‚¹å‡» OCR åŸæ–‡ä¸­çš„é‡‘é¢æ•°å­—ï¼Œå¯ä¸€é”®å†™å…¥é‡‘é¢
        </div>
        <div class="row" style="gap:8px">
          <button class="secondary" onclick="pickInvoices()">é€‰æ‹©å›¾ç‰‡</button>
          <button class="secondary" onclick="clearInvoiceDrafts()">æ¸…ç©ºé˜Ÿåˆ—</button>
        </div>
      </div>

      <!-- å¤ç”¨ä½ å·²æœ‰çš„ file inputï¼ˆä¹Ÿå¯ä»¥æ–°å»ºä¸€ä¸ªï¼Œæœ€å°æ”¹åŠ¨ç›´æ¥å¤ç”¨ï¼‰ -->
      <!-- ä½ ç°åœ¨å·²æœ‰ï¼š<input id="invoiceFiles" type="file" ...> -->
      <!-- å»ºè®®æŠŠ invoiceFiles ä» modalBill æŒªåˆ°è¿™é‡Œï¼›ä¸æŒªä¹Ÿèƒ½ç”¨ï¼ˆDOM åªè¦å­˜åœ¨å³å¯ï¼‰ -->

      <div class="hr"></div>

      <!-- ç¿»é¡µå®¹å™¨ -->
      <div id="invoicePagerBox" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Modal: Share -->
<div class="modalMask" id="modalShare">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">åä½œ / åˆ†äº«ï¼ˆ6ä½å£ä»¤ï¼‰</div>
      <button class="ghost" onclick="closeModal('share')">å…³é—­</button>
    </div>
    <div class="modalBody">

      <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid var(--line); background:rgba(75,107,255,.04)">
        <div style="font-weight:950">å½“å‰æˆ¿é—´</div>
        <div class="hint" style="margin-top:6px">
          - é‚€è¯·é“¾æ¥åªå¸¦ <span class="kbd">room</span>ï¼Œå£ä»¤è¯·ä½ å•ç‹¬å‘ç»™å¯¹æ–¹ï¼ˆç¾¤é‡Œ/ç§èŠï¼‰ã€‚<br/>
          - åŠ å…¥æˆåŠŸåå¼¹çª—ä¼šè‡ªåŠ¨å…³é—­ï¼Œå¹¶æç¤ºâ€œè¿›å…¥æˆåŠŸâ€ã€‚
        </div>

        <div class="hr"></div>

        <div class="col2">
          <div>
            <label>å½“å‰ room</label>
            <input id="roomIdBox" readonly />
          </div>
          <div>
            <label>é‚€è¯·é“¾æ¥</label>
            <input id="inviteLinkBox" readonly />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="copyInviteLink()">å¤åˆ¶é‚€è¯·é“¾æ¥</button>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950">åˆ›å»ºæ–°æˆ¿é—´</div>
        <div class="col2" style="margin-top:10px">
          <div>
            <label>æ–°æˆ¿é—´å£ä»¤ï¼ˆ6ä½æ•°å­—ï¼‰</label>
            <input id="createPassInput" inputmode="numeric" maxlength="6" placeholder="ä¾‹å¦‚ï¼š123456" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button onclick="createNewRoom()">åˆ›å»º</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950">åŠ å…¥å·²æœ‰æˆ¿é—´</div>
        <div class="col2" style="margin-top:10px">
          <div>
            <label>roomï¼ˆä¼šè‡ªåŠ¨ä»é“¾æ¥å¡«å…¥ï¼‰</label>
            <input id="joinRoomInput" placeholder="ä¾‹å¦‚ï¼šb7k2p9xq" />
          </div>
          <div>
            <label>6ä½å£ä»¤</label>
            <input id="joinPassInput" inputmode="numeric" maxlength="6" placeholder="ä¾‹å¦‚ï¼š123456" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="joinRoom()">åŠ å…¥</button>
        </div>

        <div class="hint" style="margin-top:10px">
          å°æç¤ºï¼šå¦‚æœä½ åˆ·æ–°é¡µé¢ï¼Œç³»ç»Ÿä¼šå°è¯•ä»æœ¬æœºè®°ä½çš„å£ä»¤è‡ªåŠ¨é‡è¿ï¼ˆåŒä¸€å°è®¾å¤‡æœ‰æ•ˆï¼‰ã€‚
        </div>
        <div class="hr"></div>

        <div style="font-weight:950">AIï¼ˆä»…ä½ æœ¬äººä½¿ç”¨ï¼‰</div>
        <div class="hint" style="margin-top:6px">
          - APP_TOKEN åªä¿å­˜åœ¨ä½ æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸ä¼šåŒæ­¥åˆ° Firebaseã€‚<br/>
          - ä¸è¦æŠŠ APP_TOKEN å†™è¿› GitHub ä»£ç æˆ–å‘ç»™åˆ«äººã€‚
        </div>
        
        <div class="col2" style="margin-top:10px">
          <div>
            <label>APP_TOKENï¼ˆæœ¬æœºä¿å­˜ï¼‰</label>
            <input id="aiTokenInputShare" type="password" placeholder="ç²˜è´´ä½ çš„ APP_TOKEN" />
            <div class="hint" id="aiTokenStatusShare" style="margin-top:6px"></div>
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="secondary" onclick="saveAiToken()">ä¿å­˜</button>
            <button class="danger" onclick="clearAiToken()">æ¸…é™¤</button>
          </div>
        </div>
        
        <div class="row" style="margin-top:10px">
          <button onclick="openModal('ai')">æ‰“å¼€ AI èŠå¤©</button>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div style="font-weight:950">å¤‡ä»½ / å¯¼å…¥ï¼ˆå¯é€‰ï¼‰</div>
        <div class="hint">ç”¨äºæ‰‹åŠ¨å¤‡ä»½æˆ–è¿ç§»ã€‚</div>
        <div style="margin-top:10px">
          <label>JSON</label>
          <textarea id="jsonBox" rows="8" placeholder="ç‚¹â€œå¯¼å‡ºâ€ç”Ÿæˆï¼›æˆ–ç²˜è´´ JSON ç‚¹â€œå¯¼å…¥â€"></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="exportJSONToBox()">å¯¼å‡ºåˆ°æ–‡æœ¬æ¡†</button>
          <button class="secondary" onclick="importJSONFromBox()">ä»æ–‡æœ¬æ¡†å¯¼å…¥</button>
          <button class="danger" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal: AI -->
<div class="modalMask" id="modalAI">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">AI åŠ©æ‰‹ï¼ˆè´¦å•/åˆ†æ‘Š/ç»“ç®—ï¼‰</div>
      <button class="ghost" onclick="closeModal('ai')">å…³é—­</button>
    </div>
    <div class="modalBody">
      <div id="aiMsgs" style="display:flex; flex-direction:column; gap:10px;"></div>

      <div class="hr"></div>

      <label>è¾“å…¥</label>
      <textarea id="aiInput" rows="3" placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªç»“ç®—æ˜¯å¦åˆç†ï¼Ÿ"></textarea>

      <div class="row" style="margin-top:10px; justify-content:space-between">
        <button class="secondary" onclick="seedAiContext()">å¸¦å…¥å½“å‰è´¦å•æ‘˜è¦</button>
        <button onclick="sendAi()">å‘é€</button>
      </div>

      <div class="hint" id="aiHint" style="margin-top:10px"></div>
    </div>
  </div>
</div>
  
<!-- Modal: AI Settings -->
<div class="modalMask" id="modalAISettings">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">AI è®¾ç½®ï¼ˆä»…æœ¬æœºï¼‰</div>
      <button class="ghost" onclick="closeModal('aiSettings')">å…³é—­</button>
    </div>
    <div class="modalBody">
      <div class="hint" style="margin-bottom:10px">
        - APP_TOKEN åªä¿å­˜åœ¨ä½ æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸ä¼šåŒæ­¥åˆ° Firebaseã€‚<br/>
        - å¿…é¡»å…ˆåŠ å…¥æˆ¿é—´å¹¶è¾“å…¥ 6 ä½å£ä»¤ï¼Œæ‰èƒ½è°ƒç”¨ AIã€‚
      </div>

      <label>APP_TOKENï¼ˆæœ¬æœºä¿å­˜ï¼‰</label>
      <input id="aiTokenInputSettings" type="password" placeholder="ç²˜è´´ä½ çš„ APP_TOKEN" />
      <div class="hint" id="aiTokenStatusSettings" style="margin-top:6px"></div>
      <div class="row" style="margin-top:12px">
        <button class="secondary" onclick="saveAiToken()">ä¿å­˜</button>
        <button class="danger" onclick="clearAiToken()">æ¸…é™¤</button>
        <button onclick="openModal('ai')">æ‰“å¼€ AI èŠå¤©</button>
      </div>
    </div>
  </div>
</div>
  
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js';

  // ===== AI settings =====
  const WORKER_BASE = "https://derfriendtrip.hxy94045.workers.dev";
  const AI_TOKEN_KEY = "aa_ai_app_token_v1";
  let aiHistory = []; // ä»…æœ¬æœºï¼Œä¸åŒæ­¥
  
  function getAiToken(){ return localStorage.getItem(AI_TOKEN_KEY) || ""; }
  function setAiToken(t){ localStorage.setItem(AI_TOKEN_KEY, t); }
  function delAiToken(){ localStorage.removeItem(AI_TOKEN_KEY); }
  
function refreshAiTokenStatus(){
  const msg = getAiToken() ? "âœ… å·²è®¾ç½® APP_TOKENï¼ˆä»…æœ¬æœºï¼‰" : "âš ï¸ æœªè®¾ç½® APP_TOKENï¼ˆæ— æ³•è°ƒç”¨ AIï¼‰";
  const el1 = document.getElementById("aiTokenStatusShare");
  const el2 = document.getElementById("aiTokenStatusSettings");
  if(el1) el1.textContent = msg;
  if(el2) el2.textContent = msg;
}

function saveAiToken(){
  const i1 = document.getElementById("aiTokenInputShare");
  const i2 = document.getElementById("aiTokenInputSettings");
  const v = ((i1?.value || i2?.value || "")).trim();
  if(!v){ toast("è¯·è¾“å…¥ APP_TOKEN"); return; }
  setAiToken(v);
  if(i1) i1.value = "";
  if(i2) i2.value = "";
  refreshAiTokenStatus();
  toast("å·²ä¿å­˜ APP_TOKENï¼ˆä»…æœ¬æœºï¼‰");
}

  function clearAiToken(){
    delAiToken();
    refreshAiTokenStatus();
    toast("å·²æ¸…é™¤ APP_TOKEN");
  }

// ä»OCRæ–‡æœ¬ä¸­æå–å‘ç¥¨ä¿¡æ¯
function extractInvoiceInfoFromText(ocrText) {
    const result = {
        merchant: 'æœªçŸ¥å•†å®¶',
        invoice_date: new Date().toISOString().split('T')[0],
        total: 0,
        currency: 'USD',
        suggest_title: 'å‘ç¥¨',
        notes: ''
    };
    
    const text = ocrText.toLowerCase();
    
    // 1. æå–å•†å®¶åç§°ï¼ˆæŸ¥æ‰¾å¸¸è§çš„å•†å®¶å…³é”®è¯ï¼‰
    const merchantPatterns = [
        /(?:the\s+)?([a-z\s]+(?:\s+(?:restaurant|store|shop|cafe|hotel|spot)))/i,
        /(?:at|from)\s+([a-z\s&]+)/i,
        /([a-z]+\s+(?:restaurant|store|shop|cafe|hotel))/i
    ];
    
    for (const pattern of merchantPatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            result.merchant = match[1].trim().toUpperCase();
            break;
        }
    }
    
    // 2. æå–é‡‘é¢ï¼ˆæŸ¥æ‰¾Total, Amount, $ç­‰ï¼‰
    const amountPatterns = [
        /total\s*[:=]?\s*\$?\s*(\d+\.?\d*)/i,
        /amount\s*[:=]?\s*\$?\s*(\d+\.?\d*)/i,
        /\$\s*(\d+\.?\d*)/,
        /total.*?(\d+\.\d{2})/i
    ];
    
    for (const pattern of amountPatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            result.total = parseFloat(match[1]);
            break;
        }
    }
    
    // 3. æå–æ—¥æœŸï¼ˆYYYY-MM-DD, MM/DD/YYYYç­‰æ ¼å¼ï¼‰
    const datePatterns = [
        /(\d{4}[-/]\d{1,2}[-/]\d{1,2})/,
        /(\d{1,2}[-/]\d{1,2}[-/]\d{4})/,
        /date\s*[:=]?\s*(\d{1,2}[-/]\d{1,2}[-/]\d{4})/i
    ];
    
    for (const pattern of datePatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            const dateStr = match[1];
            // å°è¯•è§£ææ—¥æœŸ
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    result.invoice_date = date.toISOString().split('T')[0];
                }
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
            break;
        }
    }
    
    // 4. æå–å¤‡æ³¨ï¼ˆå‰100ä¸ªå­—ç¬¦ï¼‰
    result.notes = ocrText.substring(0, 100).replace(/\n/g, ' ');
    
    // 5. æ ¹æ®å•†å®¶åç”Ÿæˆå»ºè®®æ ‡é¢˜
    if (result.merchant !== 'æœªçŸ¥å•†å®¶') {
        result.suggest_title = result.merchant + ' å‘ç¥¨';
    }
    
    return result;
}

  // ===== AI UI =====
  function renderAiMsgs(){
    const box = document.getElementById("aiMsgs");
    if(!box) return;
    box.innerHTML = "";
    if(aiHistory.length === 0){
      box.innerHTML = `<div class="hint">æç¤ºï¼šå…ˆåŠ å…¥æˆ¿é—´å¹¶è¾“å…¥å£ä»¤ï¼Œå†åœ¨â€œåä½œ/åˆ†äº«â€é‡Œä¿å­˜ APP_TOKENï¼Œç„¶åå°±èƒ½èŠå¤©ã€‚</div>`;
      return;
    }
    for(const m of aiHistory){
      const div = document.createElement("div");
      div.className = "ai-bubble " + (m.role === "user" ? "ai-user" : "ai-assistant");
      div.textContent = m.content || "";
      box.appendChild(div);
    }
    // æ»šåˆ°åº•
    box.parentElement?.scrollTo?.({ top: 999999, behavior:"smooth" });
  }
  
  function seedAiContext(){
    // æŠŠå½“å‰è´¦å•çš„æ‘˜è¦å¡åˆ°è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿æé—®
    const txt = document.getElementById("aiInput");
    if(!txt) return;
  
    const { owed, paid, net } = computeTotals();
    const transfers = computeSettlement(net);
  
    const billsBrief = state.bills.map(b=>{
      const billDays = daysInclusive(b.start, b.end);
      const ps = (b.participants||[]).length;
      return `- ${b.title} | payer=${b.payer} | $${Number(b.amount||0).toFixed(2)} | ${billDays}å¤© | ${ps}äºº`;
    }).join("\n") || "(æš‚æ— è´¦å•)";
  
    const peopleBrief = state.people.map(p=>{
      const n = net.get(p)||0;
      return `- ${p}: net=$${centsToMoney(n)}`;
    }).join("\n") || "(æš‚æ— äººå‘˜)";
  
    const transBrief = transfers.map(t=>`${t.from} -> ${t.to}: $${centsToMoney(t.amountC)}`).join("\n") || "(æ— éœ€è½¬è´¦)";
  
    txt.value =
  `æˆ‘å½“å‰çš„è´¦å•/åˆ†æ‘Šæƒ…å†µå¦‚ä¸‹ï¼Œè¯·å¸®æˆ‘åˆ†æ/æ£€æŸ¥/ç»™å»ºè®®ï¼š
  
  è´¦å•ï¼š
  ${billsBrief}
  
  æ¯äººå‡€é¢ï¼ˆpaid-owedï¼‰ï¼š
  ${peopleBrief}
  
  æœ€å°‘è½¬è´¦æ–¹æ¡ˆï¼š
  ${transBrief}
  
  æˆ‘çš„é—®é¢˜æ˜¯ï¼š`;
    toast("å·²å¸¦å…¥æ‘˜è¦");
  }
  
// ä¿®æ”¹ callAI å‡½æ•°ï¼Œè°ƒç”¨ä½ çš„workerè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨DeepSeek API
async function callAI(messages) {
    if(!roomId) throw new Error("è¯·å…ˆåŠ å…¥æˆ¿é—´");
    if(!/^\d{6}$/.test(passcode||"")) throw new Error("è¯·å…ˆè¾“å…¥6ä½å£ä»¤");
    
    const token = getAiToken(); // è¿™æ˜¯ä½ çš„APP_TOKENï¼Œç”¨äºè®¿é—®worker
    if(!token) throw new Error("è¯·å…ˆåœ¨'åä½œ/åˆ†äº«'é‡Œä¿å­˜APP_TOKEN");

    const response = await fetch("https://derfriendtrip.hxy94045.workers.dev/ai", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-APP-TOKEN": token, // ä½¿ç”¨X-APP-TOKENå¤´
        },
        body: JSON.stringify({
            roomId,
            passcode,
            messages,
            model: "deepseek-chat",
            temperature: 0.2
        })
    });

    if(!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || `AIè¯·æ±‚å¤±è´¥ï¼ˆ${response.status}ï¼‰`);
    }

    const data = await response.json();
    // DeepSeek è¿”å›ç»“æ„ï¼šchoices[0].message.content
    return data?.choices?.[0]?.message?.content ?? JSON.stringify(data);
}
  
// ä¼˜åŒ–å›¾ç‰‡å‹ç¼©ï¼Œç¡®ä¿base64å¤§å°åˆé€‚
async function compressImageForAPI(file, maxSizeKB = 500) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // é™åˆ¶æœ€å¤§å°ºå¯¸
                const maxDimension = 1024;
                if(width > maxDimension || height > maxDimension) {
                    const ratio = Math.min(maxDimension / width, maxDimension / height);
                    width = Math.floor(width * ratio);
                    height = Math.floor(height * ratio);
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½¬æ¢ä¸ºjpegï¼Œè´¨é‡0.7ä»¥å‡å°å¤§å°
                const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                
                // æ£€æŸ¥å¤§å°
                const sizeInKB = (base64.length * 3) / (4 * 1024);
                if(sizeInKB > maxSizeKB) {
                    console.warn(`å›¾ç‰‡å¤§å°${sizeInKB.toFixed(1)}KBè¶…è¿‡${maxSizeKB}KBé™åˆ¶ï¼Œå¯èƒ½ä¼šå½±å“è¯†åˆ«`);
                }
                
                resolve(base64);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}  
  async function sendAi(){
    const input = document.getElementById("aiInput");
    const hint = document.getElementById("aiHint");
    const text = (input?.value || "").trim();
    if(!text){ toast("è¯·è¾“å…¥å†…å®¹"); return; }
  
    try{
      hint.textContent = "AI æ­£åœ¨æ€è€ƒâ€¦";
      aiHistory.push({ role:"user", content:text });
      renderAiMsgs();
      input.value = "";
  
      const sys = {
        role: "system",
        content: "ä½ æ˜¯è´¦å•åˆ†æ‘ŠåŠ©æ‰‹ã€‚ç”¨æˆ·ä½¿ç”¨â€œäººå¤©â€åˆ†æ‘Šï¼Œä»˜æ¬¾äººå«ä»˜ï¼Œæœ€åç”¨å‡€é¢ä¸æœ€å°‘è½¬è´¦æ–¹æ¡ˆç»“ç®—ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå°½é‡ç»™å‡ºå¯æ‰§è¡Œå»ºè®®ã€‚"
      };
      const msgs = [sys, ...aiHistory.slice(-12)]; // åªå¸¦æœ€è¿‘å¯¹è¯ï¼Œé¿å…å¤ªé•¿
  
      const ans = await callAI(msgs);
      aiHistory.push({ role:"assistant", content: ans });
      renderAiMsgs();
      hint.textContent = "";
    }catch(e){
      hint.textContent = "";
      toast(e.message || "AI è°ƒç”¨å¤±è´¥");
    }
  }
  
  const ACCENT_PALETTE = [
    ["#12c2ff","#3b5cff"], // cyan->blue
    ["#b24bff","#3b5cff"], // purple->blue
    ["#ff9f2f","#ff3b7a"], // orange->pink
    ["#14b86a","#12c2ff"], // green->cyan
    ["#ff3b7a","#b24bff"], // pink->purple
    ["#3b5cff","#14b86a"], // blue->green
  ];
  
  
  
  function hashStr(s){
    s = String(s||"");
    let h = 2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0);
  }
  function accentForName(name){
    const idx = hashStr(name) % ACCENT_PALETTE.length;
    return ACCENT_PALETTE[idx];
  }

  // ===== Tabs logic =====
  const TAB_KEY = "aa_main_tab_v1";
  let activeTab = localStorage.getItem(TAB_KEY) || "bills";
  
  function setActiveTab(tab){
    activeTab = tab;
    localStorage.setItem(TAB_KEY, tab);
  
    // buttons
    document.querySelectorAll("#mainTabs .tabBtn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
  
    // panels
    const map = {
      bills: document.getElementById("panelBills"),
      summary: document.getElementById("panelSummary"),
      settle: document.getElementById("panelSettle"),
    };
    Object.entries(map).forEach(([k, el])=>{
      if(el) el.classList.toggle("active", k === tab);
    });
  }
  
  // bind clicks
  document.querySelectorAll("#mainTabs .tabBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
  });
    
  // ========= 1) æŠŠä½ çš„ Firebase Web config ç²˜è´´åˆ°è¿™é‡Œ =========
  const firebaseConfig = {
    apiKey: "AIzaSyDhLRcOhh1eTIGHZ8aSZdBZmPH9PuB_P4k",
    authDomain: "friendtrip-4ead0.firebaseapp.com",
    projectId: "friendtrip-4ead0",
    storageBucket: "friendtrip-4ead0.firebasestorage.app",
    messagingSenderId: "342171915268",
    appId: "1:342171915268:web:98c7133b35bc20c6171151",
    measurementId: "G-8NX6SFYXV8"
  };

  // ========= åŸºç¡€å·¥å…· =========
  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>t.style.display="none", 1800);
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function daysInclusive(startStr, endStr){
    if(!startStr || !endStr) return 0;
    const s = new Date(startStr + "T00:00:00");
    const e = new Date(endStr + "T00:00:00");
    const diff = Math.round((e - s) / (1000*60*60*24));
    return diff >= 0 ? diff + 1 : 0;
  }
  function toCents(x){
    const n = Number(x);
    if(!isFinite(n)) return 0;
    return Math.round(n * 100);
  }
  function centsToMoney(c){
    const sign = c < 0 ? "-" : "";
    c = Math.abs(c);
    const dollars = Math.floor(c / 100);
    const cents = String(c % 100).padStart(2, "0");
    return `${sign}${dollars}.${cents}`;
  }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function readOptionalNumber(inputEl){
  if(!inputEl) return null;
  const raw = String(inputEl.value ?? "").trim();
  if(raw === "") return null;          // âœ… ç©ºå°±æ˜¯çœŸç©º
  const n = Number(raw);
  return isFinite(n) ? n : null;
}

function getTipPercentFromUI(){
  const v = document.querySelector('input[name="tipPreset"]:checked')?.value || "0";
  if(v === "other"){
    const x = Number(document.getElementById("billTipOther")?.value);
    return clamp(isFinite(x) ? x : 0, 0, 25);
  }
  return clamp(Number(v)||0, 0, 25);
}
  
function getBaseSubtotalForTip(){
  const subEl = document.getElementById("billSubtotal");
  const amtEl = document.getElementById("billAmount");
  if(!amtEl) return 0;

  // 1) ç”¨æˆ·å¡«äº† subtotalï¼šå®ƒå°±æ˜¯åŸºå‡†
  if(subEl && subEl.value !== "" && subEl.value != null){
    const v = Number(subEl.value);
    const base = isFinite(v) ? Math.max(0, v) : 0;
    amtEl.dataset.baseSubtotal = String(base); // åŒæ­¥ä¸€ä¸‹ï¼Œæ–¹ä¾¿åç»­ä¸€è‡´
    return base;
  }

  // 2) æ²¡å¡« subtotalï¼šä¼˜å…ˆç”¨æ›¾ç»è®°ä½çš„åŸºå‡†ï¼Œé¿å…é‡å¤å åŠ 
  const ds = Number(amtEl.dataset.baseSubtotal);
  if(isFinite(ds)) return Math.max(0, ds);

  // 3) ç¬¬ä¸€æ¬¡ï¼šæŠŠå½“å‰ amount å½“ä½œåŸºå‡†
  const cur = Number(amtEl.value);
  const base = isFinite(cur) ? Math.max(0, cur) : 0;
  amtEl.dataset.baseSubtotal = String(base);
  return base;
}

function recalcBillTotalFromTip(){
  const amtEl = document.getElementById("billAmount");
  if(!amtEl) return;

  const pct = getTipPercentFromUI();
  const base = getBaseSubtotalForTip();   // âœ… å…³é”®ï¼šä¸å¡« subtotal ä¹Ÿèƒ½å–åˆ°â€œåŸºå‡†å°è®¡â€
  const total = base * (1 + pct/100);

  // âœ… total=0 ä¹Ÿå†™ 0.00ï¼Œä¸å†™ç©º
  amtEl.value = total.toFixed(2);
}



function bindTipEventsOnce(){
  const subEl = document.getElementById("billSubtotal");
  const otherEl = document.getElementById("billTipOther");
  const amtEl = document.getElementById("billAmount");
  if(!subEl || subEl.dataset.tipBound) return;
  subEl.dataset.tipBound = "1";

  subEl.addEventListener("input", recalcBillTotalFromTip);

  document.querySelectorAll('input[name="tipPreset"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      const isOther = r.value==="other" && r.checked;
      if(otherEl){
        otherEl.disabled = !isOther;
        if(isOther){
          otherEl.focus();
        }
      }
      recalcBillTotalFromTip();
    });
  });

  if(otherEl){
    otherEl.addEventListener("input", ()=>{
      // è¾“å…¥å…¶ä»–æ¯”ä¾‹æ—¶è‡ªåŠ¨é€‰ä¸­ other
      const otherRadio = document.querySelector('input[name="tipPreset"][value="other"]');
      if(otherRadio) otherRadio.checked = true;
      otherEl.disabled = false;
      recalcBillTotalFromTip();
    });
  }
  // âœ… ç”¨æˆ·æ‰‹åŠ¨æ”¹â€œé‡‘é¢â€æ—¶ï¼ˆä¸”æ²¡å¡« subtotalï¼‰ï¼ŒæŠŠå®ƒå½“ä½œæ–°çš„åŸºå‡†å°è®¡
if(amtEl && !amtEl.dataset.baseBound){
  amtEl.dataset.baseBound = "1";
  amtEl.addEventListener("input", ()=>{
    const subEl2 = document.getElementById("billSubtotal");
    if(subEl2 && subEl2.value !== "" && subEl2.value != null) return; // æœ‰ subtotal å°±ä¸ç®¡
    const v = Number(amtEl.value);
    amtEl.dataset.baseSubtotal = String(isFinite(v) ? Math.max(0, v) : 0);
  });
}

}
  
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function roomIdRandom(){
    const chars = "abcdefghjkmnpqrstuvwxyz23456789";
    let out = "";
    for(let i=0;i<8;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  function getRoomFromUrl(){
    const u = new URL(location.href);
    return u.searchParams.get("room") || "";
  }
  function setRoomToUrl(room){
    const u = new URL(location.href);
    u.searchParams.set("room", room);
    u.hash = "";
    history.replaceState(null, "", u.toString());
  }
  function inviteLink(room){
    const u = new URL(location.href);
    u.searchParams.set("room", room);
    u.hash = "";
    return u.toString();
  }
  function isSixDigits(x){ return /^[0-9]{6}$/.test(String(x||"").trim()); }

  // ========= åŠ å¯†ï¼šAES-GCM + PBKDF2 =========
  function b64urlFromBytes(bytes){
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function bytesFromB64url(b64url){
    let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
    while(b64.length % 4) b64 += "=";
    const bin = atob(b64);
    return Uint8Array.from(bin, c => c.charCodeAt(0));
  }
  async function sha256Hex(str){
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function deriveAesKey(passcode, roomId){
    const salt = new TextEncoder().encode("room:" + roomId);
    const baseKey = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(passcode),
      "PBKDF2",
      false,
      ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      { name:"PBKDF2", salt, iterations: 100000, hash:"SHA-256" },
      baseKey,
      { name:"AES-GCM", length: 256 },
      false,
      ["encrypt","decrypt"]
    );
  }
  async function encryptState(stateObj, passcode, roomId){
    const key = await deriveAesKey(passcode, roomId);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const plaintext = new TextEncoder().encode(JSON.stringify(stateObj));
    const cipherBuf = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, plaintext);
    return { iv: b64urlFromBytes(iv), cipher: b64urlFromBytes(new Uint8Array(cipherBuf)) };
  }
  async function decryptState(cipherB64url, ivB64url, passcode, roomId){
    const key = await deriveAesKey(passcode, roomId);
    const iv = bytesFromB64url(ivB64url);
    const cipherBytes = bytesFromB64url(cipherB64url);
    const plainBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, cipherBytes);
    const json = new TextDecoder().decode(new Uint8Array(plainBuf));
    return JSON.parse(json);
  }

  // ========= æœ¬åœ°çŠ¶æ€ =========
const STORAGE_KEY = "aa_split_state_secure_v1";
const PASS_STORE_KEY = "aa_room_pass_secure_v1";
let editingBillId = null;

// ç¡®ä¿stateæœ‰æ­£ç¡®çš„ç»“æ„
let state = { 
    people: [], 
    bills: [],
    // å¦‚æœæœ‰å…¶ä»–å­—æ®µä¹Ÿåœ¨è¿™é‡Œæ·»åŠ 
};

function loadLocal(){
    try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
            const obj = JSON.parse(raw);
            if(obj && Array.isArray(obj.people) && Array.isArray(obj.bills)) {
                state = obj;
            } else {
                // å¦‚æœç»“æ„ä¸å¯¹ï¼Œä½¿ç”¨é»˜è®¤ç»“æ„
                state = { people: [], bills: [] };
            }
        } else {
            state = { people: [], bills: [] };
        }
    }catch(e){
        console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', e);
        state = { people: [], bills: [] };
    }
}

function saveLocal(){
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e) {
        console.error('ä¿å­˜æœ¬åœ°æ•°æ®å¤±è´¥:', e);
    }
}
  function storePass(roomId, pass){
    try{
      const raw = localStorage.getItem(PASS_STORE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      obj[roomId] = pass;
      localStorage.setItem(PASS_STORE_KEY, JSON.stringify(obj));
    }catch(e){}
  }
  function getStoredPass(roomId){
    try{
      const raw = localStorage.getItem(PASS_STORE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return obj[roomId] || "";
    }catch(e){ return ""; }
  }

  // ========= å¼¹çª— =========
  function openModal(which){
    if(which==="person") $("modalPerson").style.display="flex";
    if(which==="ai"){
      document.getElementById("modalAI").style.display="flex";
      refreshAiTokenStatus();
      renderAiMsgs();
    }
    if(which==="aiSettings"){
      document.getElementById("modalAISettings").style.display="flex";
      refreshAiTokenStatus();
    }
    if(which==="bill"){
      if(state.people.length===0){ toast("å…ˆæ·»åŠ è‡³å°‘ 1 ä¸ªäºº"); openModal("person"); return; }
      editingBillId = null; // âœ… é»˜è®¤è¿›å…¥åˆ›å»ºæ¨¡å¼
      editingFromBillDraft = false;
      seedBillForm();
      // æ ‡é¢˜/æŒ‰é’®æ–‡å­—
      document.querySelector("#modalBill .modalTitle").textContent = "æ·»åŠ è´¦å•";
      $("billSaveBtn").textContent = "åˆ›å»º";
      $("modalBill").style.display="flex";
    }
    showBillDraftBarIfNeeded();
    if(which==="invoice"){
      document.getElementById("modalInvoice").style.display="flex";
      renderInvoicePager();
    }
    
    if(which==="share"){
      refreshCollabUI();
      const urlRoom = getRoomFromUrl();
      if(urlRoom){
        $("joinRoomInput").value = urlRoom;
        const sp = getStoredPass(urlRoom);
        if(sp) $("joinPassInput").value = sp;
        setTimeout(()=> $("joinPassInput").focus(), 0);
      }
      $("modalShare").style.display="flex";
    }

  }
  function openAiEntry(){
  // å¿…é¡»å…ˆåŠ å…¥æˆ¿é—´ + æœ‰ 6 ä½å£ä»¤
  if(!roomId || !/^\d{6}$/.test(passcode||"")){
    toast("è¯·å…ˆåœ¨â€œåä½œâ€åŠ å…¥æˆ¿é—´å¹¶è¾“å…¥ 6 ä½å£ä»¤");
    openModal("share");
    return;
  }
  // æ²¡ tokenï¼šå…ˆå»è®¾ç½®
  if(!getAiToken()){
    openModal("aiSettings");
    return;
  }
  // æœ‰ tokenï¼šç›´æ¥è¿›èŠå¤©
  openModal("ai");
}
window.openAiEntry = openAiEntry;

  function closeModal(which){
    if(which==="person") $("modalPerson").style.display="none";
    if(which==="ai") document.getElementById("modalAI").style.display="none";
    if(which==="invoice") document.getElementById("modalInvoice").style.display="none";
    if(which==="aiSettings") document.getElementById("modalAISettings").style.display="none";
    if(which==="bill"){
      // âœ… æ¸…ç†ç¼–è¾‘çŠ¶æ€ï¼ˆæ–°å¢ï¼‰
      editingBillId = null;
      document.querySelector("#modalBill .modalTitle").textContent = "æ·»åŠ è´¦å•";
      const btn = document.getElementById("billSaveBtn");
      if(btn) btn.textContent = "åˆ›å»º";
  
      $("modalBill").style.display="none";
    }
  
    if(which==="share") $("modalShare").style.display="none";
  }


  // ========= äººå‘˜ =========
  function addPerson(){
    const name = $("personName").value.trim();
    if(!name) return;
    if(state.people.includes(name)){ toast("è¯¥äººå‘˜å·²å­˜åœ¨"); return; }
    state.people.push(name);
    $("personName").value="";
    touchAndRender("å·²æ·»åŠ äººå‘˜");
    closeModal("person");
  }

  function renderPeople(){
    const box = $("peoplePills");
    box.innerHTML="";
    if(state.people.length===0){
      box.innerHTML = `<div class="hint">è¿˜æ²¡æœ‰äººå‘˜ï¼Œç‚¹åº•éƒ¨â€œ+äººâ€æ·»åŠ ã€‚</div>`;
      return;
    }
    state.people.forEach(p=>{
      const el=document.createElement("span");
      el.className="pill";
      el.innerHTML = `<b>${escapeHtml(p)}</b><span class="muted">äººå‘˜</span><span class="x">âœ•</span>`;
      el.querySelector(".x").addEventListener("click", ()=>{
        state.people = state.people.filter(x=>x!==p);
        state.bills.forEach(b=>{
          b.participants = (b.participants||[]).filter(pp=>pp.name!==p);
          if(b.payer===p) b.payer="";
        });
        touchAndRender("å·²åˆ é™¤äººå‘˜");
      });
      box.appendChild(el);
    });
  }

  // ========= è´¦å•è¡¨å• =========
  // ================== å‘ç¥¨æ‰«æï¼šå¤šå¼ é˜Ÿåˆ—ï¼ˆOCRæœ¬åœ° + AIç»“æ„åŒ–ï¼‰ ==================
  let invoiceDrafts = []; 
  // item: { id, file, name, previewUrl, status, ocrText, parsed, err, applied, added }
  // ===== è´¦å•è‰ç¨¿é˜Ÿåˆ—ï¼šç”¨äºâ€œå¤šå¼ å‘ç¥¨ -> å¤šä¸ªè´¦å•è‰ç¨¿ -> åˆ†é¡µç¼–è¾‘åˆ›å»ºâ€ =====
  let billDrafts = [];      // [{id, fromInvoiceId, title, amount, start, end, payer, participantNames, subtotal, tipPercent, baseSubtotal}]
  let billDraftIndex = 0;   // å½“å‰ç¼–è¾‘ç¬¬å‡ ä¸ªè‰ç¨¿
  let editingFromBillDraft = false; // å½“å‰ modalBill æ˜¯å¦åœ¨ç¼–è¾‘è‰ç¨¿é˜Ÿåˆ—

  let currentAppliedInvoiceId = null;
  let invoicePage = 0; // å½“å‰ç¿»åˆ°ç¬¬å‡ å¼   
  // å…¥å£ï¼šç‚¹å‡»â€œæ‰«æå‘ç¥¨â€
  function scanInvoices(){
    // ç›´æ¥è¿›å…¥å‘ç¥¨æ‰«æå¼¹çª—
    openModal("invoice");
    // è‡ªåŠ¨è§¦å‘é€‰æ‹©
    setTimeout(()=> pickInvoices(), 0);
  }
  function pickInvoices(){
    const input = document.getElementById("invoiceFiles");
    if(!input) { toast("æ‰¾ä¸åˆ° invoiceFiles è¾“å…¥æ¡†"); return; }
    input.value = "";
    input.click();
  }
  
  function clearInvoiceDrafts(){
    // é‡Šæ”¾é¢„è§ˆ URL
    invoiceDrafts.forEach(x=>{
      if(x.previewUrl) URL.revokeObjectURL(x.previewUrl);
    });
    invoiceDrafts = [];
    currentAppliedInvoiceId = null;
    invoicePage = 0;
    renderInvoicePager();
    toast("å·²æ¸…ç©ºå‘ç¥¨é˜Ÿåˆ—");
  }
  
  // ç»‘å®š input changeï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
  function bindInvoiceInputOnce(){
    const input = document.getElementById("invoiceFiles");
    if(!input || input.dataset.bound) return;
    input.dataset.bound = "1";
  
    input.addEventListener("change", async ()=>{
      const files = Array.from(input.files || []);
      if(files.length === 0) return;
  
      // å»ºé˜Ÿåˆ—
      for(const f of files){
        const id = uid();
        invoiceDrafts.push({
          id,
          file: f,
          name: f.name || "invoice",
          previewUrl: URL.createObjectURL(f),
          status: "queued",
          ocrText: "",
          parsed: null,
          err: "",
          applied: false,
          added: false,
        });
      }
      renderInvoicePager();
      // ä¸²è¡Œå¤„ç†ï¼ˆé¿å…ä½  4æ¬¡/åˆ†é’Ÿ é™æµï¼‰
      await processInvoiceQueueSerial();
    });
  }
  
  let _invoiceProcessing = false;

async function processInvoiceQueueSerial() {
    if (_invoiceProcessing) return;
    _invoiceProcessing = true;

    try {
        for (const item of invoiceDrafts) {
            if (item.status !== 'queued') continue;

            item.status = 'processing';
            renderInvoicePager();

            try {
                console.log('å¤„ç†å‘ç¥¨:', item.name);
                
                // ä½¿ç”¨Tesseract.jsè¿›è¡ŒOCRè¯†åˆ«
                const result = await recognizeInvoice(item.file);
                
                if (result.success) {
                    item.parsed = result.data;
                    item.ocrText = result.rawText; // ä¿å­˜åŸå§‹OCRæ–‡æœ¬
                    item.status = 'ready';
                    toast(`âœ… ${item.name} è¯†åˆ«å®Œæˆ`);
                } else {
                    item.status = 'ready';
                    item.parsed = result.data;
                    item.err = result.error || 'è¯†åˆ«å¤±è´¥';
                    toast(`âš ï¸ ${item.name} è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™`);
                }
                
                renderInvoicePager();
                
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæˆåŠŸçš„è¯†åˆ«ï¼Œè‡ªåŠ¨åº”ç”¨åˆ°è¡¨å•
                if (result.success && !currentAppliedInvoiceId) {
                    setTimeout(() => {
                        applyInvoiceToBillForm(item.id);
                    }, 500);
                }
                
            } catch (error) {
                console.error('å¤„ç†å‘ç¥¨æ—¶å‡ºé”™:', error);
                item.status = 'ready';
                item.parsed = {
                    merchant: 'å¤„ç†å¤±è´¥',
                    invoice_date: new Date().toISOString().split('T')[0],
                    total: 0,
                    currency: 'USD',
                    suggest_title: 'å‘ç¥¨',
                    notes: `å¤„ç†å¤±è´¥: ${error.message}`
                };
                item.err = error.message;
                renderInvoicePager();
                toast(`âŒ ${item.name} å¤„ç†å¤±è´¥`);
            }

            // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å¤„ç†å¤šå¼ å›¾ç‰‡
            await new Promise(r => setTimeout(r, 1000));
        }
    } finally {
        _invoiceProcessing = false;
    }
}

// æ–‡ä»¶è½¬base64å·¥å…·å‡½æ•°
// æ–‡ä»¶è½¬base64å‡½æ•°ï¼ˆéœ€è¦æ·»åŠ ï¼‰
async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      // ç§»é™¤data:image/jpeg;base64,å‰ç¼€
      const base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function prevInvoice(){
  if(invoiceDrafts.length===0) return;
  invoicePage = Math.max(0, invoicePage - 1);
  renderInvoicePager();
}

function nextInvoice(){
  if(invoiceDrafts.length===0) return;
  invoicePage = Math.min(invoiceDrafts.length - 1, invoicePage + 1);
  renderInvoicePager();
}

function statusLabel(s){
  if(s==="queued") return "ç­‰å¾…ä¸­";
  if(s==="processing") return "è¯†åˆ«ä¸­â€¦";
  if(s==="ready") return "âœ… å·²è¯†åˆ«";
  return s || "";
}
function renderInvoicePager(){
  const box = document.getElementById("invoicePagerBox");
  if(!box) return;

  const n = invoiceDrafts.length;
  if(n===0){ box.style.display='none'; box.innerHTML=''; return; }

  invoicePage = Math.max(0, Math.min(invoicePage, n-1));
  const item = invoiceDrafts[invoicePage];
  const p = item.parsed || {};

  box.style.display='block';
  box.innerHTML = `
    <div class="card" style="box-shadow:none;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.75)">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:950">å‘ç¥¨ï¼ˆ${invoicePage+1}/${n}ï¼‰</div>
        <div class="row" style="gap:8px">
          <button class="secondary" ${invoicePage===0?'disabled':''} onclick="prevInvoice()">ä¸Šä¸€å¼ </button>
          <button class="secondary" ${invoicePage===n-1?'disabled':''} onclick="nextInvoice()">ä¸‹ä¸€å¼ </button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- é¢„è§ˆ + çŠ¶æ€ -->
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="row" style="gap:10px;align-items:flex-start">
          <img src="${item.previewUrl}" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--line)" />
          <div>
            <div style="font-weight:950">${escapeHtml(item.name)}</div>
            <div class="small muted" style="margin-top:4px">çŠ¶æ€ï¼š${escapeHtml(item.status)}</div>
            ${item.err ? `<div class="small" style="color:var(--bad);margin-top:4px">${escapeHtml(item.err)}</div>` : ''}
          </div>
        </div>

        <div class="row" style="gap:8px;align-items:center">
          ${item.ocrText ? `<button class="ghost small" onclick="showOcrText('${item.id}')">æŸ¥çœ‹åŸæ–‡</button>` : ''}
          <button class="secondary small" onclick="applyInvoiceToBillForm('${item.id}')">åº”ç”¨åˆ°è´¦å•</button>
          <button class="danger ghost small" onclick="removeInvoice('${item.id}')">ç§»é™¤</button>
        </div>
      </div>

      <!-- ç¼–è¾‘åŒºï¼ˆåªç¼–è¾‘å½“å‰è¿™ä¸€å¼ ï¼‰ -->
      <div style="margin-top:12px;padding:12px;background:rgba(59,92,255,0.05);border-radius:12px">
        <div class="col2">
          <div>
            <label class="small muted">å•†å®¶</label>
            <input type="text" value="${escapeHtml(p.merchant||'')}"
              onchange="updateInvoiceField('${item.id}','merchant',this.value)" />
          </div>
          <div>
            <label class="small muted">é‡‘é¢</label>
            <input type="number" step="0.01" value="${Number(p.total||0)}"
              onchange="updateInvoiceField('${item.id}','total',this.value)" />
          </div>
          <div>
            <label class="small muted">æ—¥æœŸ</label>
            <input type="date" value="${escapeHtml(p.invoice_date||'')}"
              onchange="updateInvoiceField('${item.id}','invoice_date',this.value)" />
          </div>
          <div>
            <label class="small muted">æ ‡é¢˜</label>
            <input type="text" value="${escapeHtml(p.suggest_title||'')}"
              onchange="updateInvoiceField('${item.id}','suggest_title',this.value)" />
          </div>
        </div>
      </div>
    </div>
  `;
}



function findMoneyTokens(text){
  // åŒ¹é… $12.34 / 12.34 / 12.3 / 12
  // ä½ ä¹Ÿå¯ä»¥æ›´ä¸¥æ ¼åªå…è®¸ä¸¤ä½å°æ•°ï¼š\d+\.\d{2}
  const re = /(\$?\s*\d{1,6}(?:,\d{3})*(?:\.\d{1,2})?)/g;
  const out = [];
  let m;
  while((m = re.exec(text)) !== null){
    out.push({ raw: m[1], idx: m.index, len: m[1].length });
  }
  return out;
}

function toNumberMoney(raw){
  const s = String(raw||"").replace(/\$/g,"").replace(/\s/g,"").replace(/,/g,"");
  const n = Number(s);
  return isFinite(n) ? n : NaN;
}

function showOcrText(id){
  const item = invoiceDrafts.find(x => x.id === id);
  if (!item || !item.ocrText) return;

  const raw = item.ocrText.substring(0, 6000);
  const tokens = findMoneyTokens(raw);

  // æŠŠ tokens æ¸²æŸ“æˆå¯ç‚¹å‡» spanï¼šç‚¹å‡»å†™å…¥ total
  let html = "";
  let last = 0;

  for(const t of tokens){
    const before = raw.slice(last, t.idx);
    html += escapeHtml(before);

    const n = toNumberMoney(t.raw);
    if(isFinite(n)){
      html += `<span
        data-money="${n}"
        style="display:inline-block;margin:2px 4px;padding:2px 8px;border-radius:999px;border:1px solid rgba(59,92,255,.25);background:rgba(59,92,255,.10);cursor:pointer;font-family:ui-monospace,monospace;"
        title="ç‚¹å‡»è®¾ä¸ºé‡‘é¢ï¼š${n.toFixed(2)}"
      >${escapeHtml(t.raw)}</span>`;
    }else{
      html += escapeHtml(t.raw);
    }

    last = t.idx + t.len;
  }
  html += escapeHtml(raw.slice(last));

  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; inset: 0;
    background: rgba(18,22,42,.50);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; padding: 14px;
  `;

  modal.innerHTML = `
    <div style="background: rgba(255,255,255,.96); border-radius: 16px; padding: 14px; max-width: 860px; width: 100%; max-height: 84vh; overflow: auto; border:1px solid rgba(18,22,42,.10)">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:950">OCR åŸæ–‡ï¼ˆç‚¹æ•°å­—å¯è®¾ä¸ºé‡‘é¢ï¼‰</div>
        <button class="ghost" type="button" data-close>å…³é—­</button>
      </div>

      <div class="hint" style="margin-bottom:10px">
        è¯´æ˜ï¼šç‚¹å‡»è“è‰²â€œæ•°å­—æ ‡ç­¾â€ä¼šæŠŠè¯¥æ•°å­—å†™å…¥è¯¥å‘ç¥¨çš„é‡‘é¢ï¼ˆTotalï¼‰ã€‚
      </div>

      <div
        style="background: rgba(18,22,42,.04); padding: 12px; border-radius: 12px;
               font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
               white-space: pre-wrap; line-height:1.55; border:1px solid rgba(18,22,42,.10);"
      >${html}</div>
    </div>
  `;

  document.body.appendChild(modal);

  // close
  modal.querySelector("[data-close]")?.addEventListener("click", ()=> modal.remove());
  modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.remove(); });

  // click token
  modal.querySelectorAll("[data-money]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const v = Number(el.getAttribute("data-money"));
      if(!isFinite(v)) return;
      updateInvoiceField(id, "total", v.toFixed(2));
      
      // å¦‚æœè¿™å¼ æ­£åº”ç”¨åœ¨è´¦å•è¡¨å•ï¼Œé¡ºä¾¿å†™å…¥ billAmount
      if(currentAppliedInvoiceId === id){
        const amtEl = document.getElementById("billAmount");
        if(amtEl) amtEl.value = v.toFixed(2);
      }
      
      toast(`å·²è®¾ä¸ºé‡‘é¢ï¼š${v.toFixed(2)}`);
      renderInvoicePager();

    });
  });
}

// å›¾ç‰‡é¢„å¤„ç†å‡½æ•°ï¼ˆæé«˜OCRå‡†ç¡®ç‡ï¼‰
async function preprocessImageForOCR(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è°ƒæ•´å¤§å°ï¼ˆé™åˆ¶æœ€å¤§å®½åº¦ï¼‰
                const maxWidth = 1200;
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = Math.floor(height * ratio);
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½¬æ¢ä¸ºBlob
                canvas.toBlob(blob => {
                    resolve(blob);
                }, 'image/jpeg', 0.9);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// å®Œæ•´çš„å‘ç¥¨è¯†åˆ«æµç¨‹ï¼ˆä½¿ç”¨é¢„å¤„ç†çš„ç‰ˆæœ¬ï¼‰
async function recognizeInvoice(file) {
    try {
        console.log('å¼€å§‹OCRè¯†åˆ«...');
        
        // é¢„å¤„ç†å›¾ç‰‡
        const processedImage = await preprocessImageForOCR(file);
        
        // ä½¿ç”¨Tesseract.js
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        
        // ä¼˜åŒ–å‚æ•°
        await worker.setParameters({
            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$.,-:/() ',
            tessedit_pageseg_mode: '6', // å‡è®¾ä¸ºå•ä¸€æ–‡æœ¬å—
        });
        
        const { data: { text } } = await worker.recognize(processedImage);
        await worker.terminate();
        
        if (!text || text.trim().length < 10) {
            throw new Error('OCRæœªè¯†åˆ«åˆ°æœ‰æ•ˆæ–‡æœ¬');
        }
        
        console.log('OCRç»“æœ:', text.substring(0, 200));
        
        // ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯
        const extractedInfo = extractInvoiceInfoFromText(text);
        
        return {
            success: true,
            data: extractedInfo,
            rawText: text
        };
        
    } catch (error) {
        console.error('å‘ç¥¨è¯†åˆ«å¤±è´¥:', error);
        
        return {
            success: false,
            data: {
                merchant: 'è¯†åˆ«å¤±è´¥',
                invoice_date: new Date().toISOString().split('T')[0],
                total: 0,
                currency: 'USD',
                suggest_title: 'å‘ç¥¨',
                notes: 'OCRè¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™'
            },
            error: error.message
        };
    }
}
  // æ›´æ–°å‘ç¥¨å­—æ®µ
  function updateInvoiceField(id, field, value) {
    const item = invoiceDrafts.find(x => x.id === id);
    if(!item || !item.parsed) return;
  
    if(field === "total"){
      const n = Number(value);
      item.parsed.total = isFinite(n) ? n : 0;
    }else{
      item.parsed[field] = String(value ?? "");
    }
  }


function removeInvoice(id) {
  const item = invoiceDrafts.find(x => x.id === id);
  if(item && item.previewUrl) URL.revokeObjectURL(item.previewUrl);

  const idx = invoiceDrafts.findIndex(x=>x.id===id);
  invoiceDrafts = invoiceDrafts.filter(x => x.id !== id);

  if(currentAppliedInvoiceId === id) currentAppliedInvoiceId = null;

  // âœ… é˜²æ­¢é¡µç è¶Šç•Œ
  if(idx <= invoicePage) invoicePage = Math.max(0, invoicePage - 1);

  renderInvoicePager();
}

  
function applyInvoiceToBillForm(draftId){
  const item = invoiceDrafts.find(x=>x.id===draftId);
  if(!item){ toast("æ‰¾ä¸åˆ°è¯¥è‰ç¨¿"); return; }

  // æ ‡è®°å½“å‰åº”ç”¨ï¼ˆå‘ç¥¨ä¾§è§†è§‰ï¼‰
  currentAppliedInvoiceId = draftId;
  invoiceDrafts.forEach(x=>x.applied=false);
  item.applied = true;

  // âœ… å¦‚æœå·²å­˜åœ¨å¯¹åº”è‰ç¨¿ï¼Œå°±ç›´æ¥è·³åˆ°é‚£ä¸€é¡µ
  const existIdx = billDrafts.findIndex(d=>d.fromInvoiceId===draftId);
  if(existIdx >= 0){
    toast("è¯¥å‘ç¥¨å·²ç”Ÿæˆè´¦å•è‰ç¨¿ï¼Œå·²è·³è½¬");
    openBillDraftAt(existIdx);
    return;
  }

  // âœ… æ–°å»ºä¸€ä¸ªè´¦å•è‰ç¨¿ï¼ŒåŠ å…¥é˜Ÿåˆ—
  const d = invoiceToBillDraft(item);
  billDrafts.push(d);
  toast(`å·²åŠ å…¥è´¦å•è‰ç¨¿é˜Ÿåˆ—ï¼ˆ${billDrafts.length}ï¼‰`);

  // æ‰“å¼€è´¦å•å¼¹çª—ï¼Œå¹¶è·³åˆ°æ–°å¢çš„é‚£ä¸€é¡µ
  openBillDraftAt(billDrafts.length - 1);

  // å‘ç¥¨å¼¹çª—ä¹Ÿåˆ·æ–°ï¼ˆå¯é€‰ï¼‰
  renderInvoicePager();
}


function invoiceToBillDraft(invoiceItem){
  const p = invoiceItem?.parsed || {};
  const title = (p.suggest_title || p.merchant || "å‘ç¥¨").trim();
  const date = (p.invoice_date || "").trim();
  const total = Number(p.total ?? 0);

  return {
    id: uid(),
    fromInvoiceId: invoiceItem.id,
    title,
    amount: isFinite(total) && total >= 0 ? total : 0,
    start: date || (new Date().toISOString().split("T")[0]),
    end: date || (new Date().toISOString().split("T")[0]),
    payer: state.people[0] || "",
    participantNames: [...state.people], // é»˜è®¤å…¨å‘˜å‚ä¸ï¼ˆä½ å¯ä»¥æ”¹æˆå‹¾é€‰é€»è¾‘ï¼‰
    subtotal: null,
    tipPercent: 0,
    baseSubtotal: isFinite(total) && total >= 0 ? total : 0, // é»˜è®¤æŠŠâ€œæ€»é¢â€å½“ä½œåŸºå‡†ï¼Œé¿å…ä¸º0
  };
}

function showBillDraftBarIfNeeded(){
  const bar = document.getElementById("billDraftBar");
  if(!bar) return;

  const on = editingFromBillDraft && billDrafts.length > 0;
  bar.style.display = on ? "block" : "none";
  if(!on) return;

  const pos = document.getElementById("billDraftPos");
  if(pos) pos.textContent = `${billDraftIndex+1}/${billDrafts.length}`;

  const prevBtn = document.getElementById("btnBillDraftPrev");
  const nextBtn = document.getElementById("btnBillDraftNext");
  const rmBtn   = document.getElementById("btnBillDraftRemove");

  if(prevBtn) prevBtn.disabled = (billDraftIndex<=0);
  if(nextBtn) nextBtn.disabled = (billDraftIndex>=billDrafts.length-1);

  if(prevBtn && !prevBtn.dataset.bound){
    prevBtn.dataset.bound="1";
    prevBtn.addEventListener("click", ()=> switchBillDraft(-1));
  }
  if(nextBtn && !nextBtn.dataset.bound){
    nextBtn.dataset.bound="1";
    nextBtn.addEventListener("click", ()=> switchBillDraft(+1));
  }
  if(rmBtn && !rmBtn.dataset.bound){
    rmBtn.dataset.bound="1";
    rmBtn.addEventListener("click", ()=> removeCurrentBillDraft());
  }
}

function captureBillFormToDraft(d){
  if(!d) return;
  d.title = document.getElementById("billTitle")?.value?.trim() || d.title;
  d.amount = Number(document.getElementById("billAmount")?.value) || 0;
  d.start = document.getElementById("billStart")?.value || d.start;
  d.end = document.getElementById("billEnd")?.value || d.end;
  d.payer = document.getElementById("billPayer")?.value || d.payer;

  const subEl = document.getElementById("billSubtotal");
  d.subtotal = (subEl && subEl.value !== "" && isFinite(Number(subEl.value))) ? Math.max(0, Number(subEl.value)) : null;

  d.tipPercent = getTipPercentFromUI();
  // åŸºå‡†å°è®¡ï¼šä¼˜å…ˆå– dataset.baseSubtotalï¼Œå¦åˆ™ fallback åˆ° subtotal/amount
  const amtEl = document.getElementById("billAmount");
  const ds = Number(amtEl?.dataset?.baseSubtotal);
  if(isFinite(ds)) d.baseSubtotal = Math.max(0, ds);
  else if(d.subtotal!=null) d.baseSubtotal = Math.max(0, Number(d.subtotal));
  else d.baseSubtotal = Math.max(0, Number(d.amount)||0);

  // å‚ä¸äººå‹¾é€‰
  const checks = document.getElementById("billParticipantsChecks");
  if(checks){
    const selected = [...checks.querySelectorAll('input[type=checkbox]:checked')].map(x=>x.value);
    if(selected.length) d.participantNames = selected;
  }
}

function loadDraftToBillForm(d){
  if(!d) return;

  seedBillForm(); // å…ˆç”Ÿæˆè¡¨å•ç»“æ„ï¼ˆpayeré€‰é¡¹ã€checkboxç­‰ï¼‰

  document.getElementById("billTitle").value = d.title || "";
  document.getElementById("billAmount").value = (Number(d.amount)||0).toFixed(2);
  document.getElementById("billStart").value = d.start || "";
  document.getElementById("billEnd").value = d.end || "";
  document.getElementById("billPayer").value = d.payer || (state.people[0]||"");

  // subtotal/tip å›å¡«
  const subEl = document.getElementById("billSubtotal");
  if(subEl) subEl.value = (d.subtotal!=null && isFinite(Number(d.subtotal))) ? Number(d.subtotal).toFixed(2) : "";

  const tp = isFinite(Number(d.tipPercent)) ? Number(d.tipPercent) : 0;
  const presets = new Set([0,18,20,25]);
  const otherEl = document.getElementById("billTipOther");
  const rOther = document.querySelector('input[name="tipPreset"][value="other"]');
  if(presets.has(tp)){
    const r = document.querySelector(`input[name="tipPreset"][value="${tp}"]`);
    if(r) r.checked = true;
    if(otherEl){ otherEl.value=""; otherEl.disabled=true; }
  }else{
    if(rOther) rOther.checked = true;
    if(otherEl){
      otherEl.disabled = false;
      otherEl.value = String(clamp(tp,0,25));
    }
  }

  // âœ… æ¢å¤ baseSubtotal
  const amtEl = document.getElementById("billAmount");
  if(amtEl){
    const bs = (d.baseSubtotal!=null && isFinite(Number(d.baseSubtotal))) ? Number(d.baseSubtotal)
            : (d.subtotal!=null && isFinite(Number(d.subtotal))) ? Number(d.subtotal)
            : (isFinite(Number(d.amount)) ? Number(d.amount) : 0);
    amtEl.dataset.baseSubtotal = String(Math.max(0, bs));
  }

  // å‚ä¸äººå‹¾é€‰å›å¡«
  const selected = new Set(d.participantNames || []);
  [...document.getElementById("billParticipantsChecks").querySelectorAll('input[type=checkbox]')].forEach(chk=>{
    chk.checked = selected.has(chk.value);
  });

  // åˆ·æ–°å¤©æ•°
  document.getElementById("billStart").dispatchEvent(new Event("change"));
  document.getElementById("billEnd").dispatchEvent(new Event("change"));

  // æ ‡é¢˜æŒ‰é’®
  document.querySelector("#modalBill .modalTitle").textContent = "æ·»åŠ è´¦å•ï¼ˆå‘ç¥¨è‰ç¨¿ï¼‰";
  document.getElementById("billSaveBtn").textContent = "åˆ›å»ºå¹¶ä¸‹ä¸€å¼ ";

  // è®¡ç®—ä¸€æ¬¡æ€»é¢ï¼ˆå¦‚æœä½ å¡«äº†subtotal/tipï¼‰
  recalcBillTotalFromTip();

  showBillDraftBarIfNeeded();
}

function openBillDraftAt(i){
  billDraftIndex = Math.max(0, Math.min(i, billDrafts.length-1));
  editingFromBillDraft = true;
  editingBillId = null; // ç¡®ä¿ä¸æ˜¯â€œç¼–è¾‘è´¦å•æ¨¡å¼â€

  // æ‰“å¼€modalBillå¹¶åŠ è½½è‰ç¨¿
  document.getElementById("modalBill").style.display = "flex";
  loadDraftToBillForm(billDrafts[billDraftIndex]);
}

function switchBillDraft(delta){
  if(billDrafts.length===0) return;

  // å…ˆä¿å­˜å½“å‰è¡¨å•åˆ°å½“å‰è‰ç¨¿
  captureBillFormToDraft(billDrafts[billDraftIndex]);

  const next = billDraftIndex + delta;
  if(next < 0 || next >= billDrafts.length) return;
  openBillDraftAt(next);
}

function removeCurrentBillDraft(){
  if(billDrafts.length===0) return;

  const removed = billDrafts.splice(billDraftIndex, 1);
  // åŒæ­¥å‘ç¥¨çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
  const invId = removed?.[0]?.fromInvoiceId;
  if(invId){
    const inv = invoiceDrafts.find(x=>x.id===invId);
    if(inv) inv.applied = false;
  }

  if(billDrafts.length===0){
    editingFromBillDraft = false;
    document.getElementById("billDraftBar").style.display="none";
    toast("å·²ç§»é™¤è‰ç¨¿ï¼ˆé˜Ÿåˆ—ä¸ºç©ºï¼‰");
    return;
  }
  billDraftIndex = Math.min(billDraftIndex, billDrafts.length-1);
  openBillDraftAt(billDraftIndex);
  toast("å·²ç§»é™¤å½“å‰è‰ç¨¿");
}  

  // è®©åˆ›å»ºæˆåŠŸåï¼šæŠŠå½“å‰åº”ç”¨çš„å‘ç¥¨æ ‡è®°ä¸ºâ€œå·²åŠ å…¥â€ï¼Œå¹¶è‡ªåŠ¨åº”ç”¨ä¸‹ä¸€å¼  ready çš„
  function afterBillCreatedFromInvoice(){
    if(!currentAppliedInvoiceId) return;
    const cur = invoiceDrafts.find(x=>x.id===currentAppliedInvoiceId);
    if(cur){
      cur.added = true;
      cur.applied = false;
    }
    currentAppliedInvoiceId = null;
  
    // è‡ªåŠ¨æ‰¾ä¸‹ä¸€å¼ å¯ç”¨çš„
    const next = invoiceDrafts.find(x => !x.added && (x.status==="ready" || x.status==="ready_ocr_only"));
    if(next){
      applyInvoiceToBillForm(next.id);
    }
    renderInvoicePager();
  }

  function seedBillForm(){
    const today=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const d=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
    if(!$("billStart").value) $("billStart").value=d;
    if(!$("billEnd").value) $("billEnd").value=d;
    
    const amtEl = document.getElementById("billAmount");
    if(amtEl){
      delete amtEl.dataset.baseSubtotal;
    }

    const payer=$("billPayer");
    payer.innerHTML="";
    state.people.forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p; opt.textContent=p;
      payer.appendChild(opt);
    });

    const checks=$("billParticipantsChecks");
    checks.innerHTML="";
    state.people.forEach(p=>{
      const div=document.createElement("label");
      div.className="checkItem";
      div.innerHTML = `<input type="checkbox" value="${escapeHtml(p)}" checked /> <span style="font-weight:900">${escapeHtml(p)}</span>`;
      checks.appendChild(div);
    });


    function updateDays(){
      const dd = daysInclusive($("billStart").value, $("billEnd").value);
      $("billDays").value = dd ? `${dd} å¤©` : "";
    }
    $("billStart").onchange=updateDays;
    $("billEnd").onchange=updateDays;
    // âœ… tip é»˜è®¤æ¸…ç©º
    const subEl = document.getElementById("billSubtotal");
    if(subEl) subEl.value = "";
    const otherEl = document.getElementById("billTipOther");
    if(otherEl){ otherEl.value = ""; otherEl.disabled = true; }
    const r0 = document.querySelector('input[name="tipPreset"][value="0"]');
    if(r0) r0.checked = true;
        
    updateDays();
    bindTipEventsOnce();
  }

  function createBill(){
    recalcBillTotalFromTip();
    const title=$("billTitle").value.trim();
    const amount=Number($("billAmount").value);
    const subtotal = readOptionalNumber(document.getElementById("billSubtotal"));
    const tipPercent = getTipPercentFromUI();
    const baseSubtotal = getBaseSubtotalForTip();
    const start=$("billStart").value;
    const end=$("billEnd").value;
    const payer=$("billPayer").value;

    const billDays=daysInclusive(start,end);
    const selected=[...$("billParticipantsChecks").querySelectorAll("input[type=checkbox]:checked")].map(x=>x.value);

    if(!title){ toast("è¯·å¡«è´¦å•åç§°"); return; }
    if(!(amount>=0)){ toast("è¯·å¡«æ­£ç¡®é‡‘é¢"); return; }
    if(!start||!end||billDays<=0){ toast("æ—¥æœŸèŒƒå›´ä¸å¯¹"); return; }
    if(!payer){ toast("è¯·é€‰æ‹©ä»˜æ¬¾äºº"); return; }
    if(selected.length===0){ toast("è‡³å°‘é€‰æ‹© 1 ä¸ªå‚ä¸äºº"); return; }

    const participantsSelected = selected;
    
    // âœ… ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°åŸè´¦å•ï¼ˆå°½é‡ä¿ç•™æ¯ä¸ªäººå·²è®¾ç½®çš„ daysï¼‰
    if(editingBillId){
      const b = state.bills.find(x=>x.id===editingBillId);
      if(!b){ toast("ç¼–è¾‘å¤±è´¥ï¼šæ‰¾ä¸åˆ°è´¦å•"); return; }
    
      b.title = title;
      b.amount = amount;
      b.start = start;
      b.end = end;
      b.payer = payer;
      b.subtotal = (subtotal != null) ? Math.max(0, subtotal) : null;
      b.tipPercent = isFinite(tipPercent) ? tipPercent : 0;
      b.baseSubtotal = isFinite(baseSubtotal) ? Math.max(0, baseSubtotal) : null;
      const oldMap = new Map((b.participants||[]).map(p=>[p.name, p.days]));
      b.participants = participantsSelected.map(name=>({
        name,
        // åŸæ¥å°±å­˜åœ¨ï¼šä¿ç•™ç”¨æˆ·æ”¹è¿‡çš„ daysï¼›æ–°åŠ å…¥ï¼šé»˜è®¤ç­‰äºè´¦å•å¤©æ•°
        days: Math.max(0, Math.floor(Number(oldMap.get(name) ?? billDays) || 0))
      }));
    
      editingBillId = null;
      $("billTitle").value=""; $("billAmount").value="";
      touchAndRender("å·²ä¿å­˜ä¿®æ”¹");
      closeModal("bill");
      return;
    }
    
    // âœ… åˆ›å»ºæ¨¡å¼ï¼šæ–°å»ºè´¦å•
    const participants = participantsSelected.map(name=>({name, days: billDays}));
    state.bills.unshift({
      id: uid(), title, amount, start, end, payer, participants,
      subtotal: (subtotal != null) ? Math.max(0, subtotal) : null,
      tipPercent: isFinite(tipPercent) ? tipPercent : 0,
      baseSubtotal: isFinite(baseSubtotal) ? Math.max(0, baseSubtotal) : null
    });

    // âœ… å¦‚æœå½“å‰æ˜¯åœ¨â€œå‘ç¥¨è‰ç¨¿é˜Ÿåˆ—æ¨¡å¼â€ï¼Œåˆ›å»ºåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å¼ 
    if(editingFromBillDraft && billDrafts.length>0){
      // å…ˆæŠŠè¡¨å•å›å†™åˆ°è‰ç¨¿ï¼ˆç¡®ä¿ä½ æ”¹çš„å†…å®¹è¢«ç”¨åˆ°ï¼‰
      captureBillFormToDraft(billDrafts[billDraftIndex]);
    
      // æ ‡è®°å‘ç¥¨ addedï¼ˆæ²¿ç”¨ä½ åŸæ¥çš„é€»è¾‘ï¼‰
      const invId = billDrafts[billDraftIndex].fromInvoiceId;
      if(invId){
        const inv = invoiceDrafts.find(x=>x.id===invId);
        if(inv){ inv.added = true; inv.applied = false; }
      }
    
      // ç§»é™¤å·²åˆ›å»ºçš„è‰ç¨¿
      billDrafts.splice(billDraftIndex, 1);
    
      if(billDrafts.length===0){
        editingFromBillDraft = false;
        closeModal("bill");
        toast("å·²åˆ›å»ºè´¦å•ï¼ˆè‰ç¨¿é˜Ÿåˆ—å·²å®Œæˆï¼‰");
        return;
      }
    
      // ç•™åœ¨å½“å‰ indexï¼ˆå› ä¸ºå½“å‰è¢«åˆ äº†ï¼Œä¸‹ä¸€å¼ ä¼šé¡¶ä¸Šæ¥ï¼‰
      billDraftIndex = Math.min(billDraftIndex, billDrafts.length-1);
      openBillDraftAt(billDraftIndex);
      toast("å·²åˆ›å»ºè´¦å•ï¼ˆå·²åˆ‡åˆ°ä¸‹ä¸€å¼ è‰ç¨¿ï¼‰");
      return;
    }

    
    $("billTitle").value=""; $("billAmount").value="";
    touchAndRender("å·²åˆ›å»ºè´¦å•");
    
    // âœ… æ–°å¢ï¼šå¦‚æœè¿™å•æ¥è‡ªå‘ç¥¨é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸ºå·²åŠ å…¥ï¼Œå¹¶è‡ªåŠ¨åˆ‡ä¸‹ä¸€å¼ 
    afterBillCreatedFromInvoice();
    
    closeModal("bill");
  }
  
  function openEditBill(billId){
    const b = state.bills.find(x=>x.id===billId);
    if(!b){ toast("æ‰¾ä¸åˆ°è¯¥è´¦å•"); return; }
  
    editingBillId = billId;
  
    // å…ˆç”¨ç°æœ‰é€»è¾‘ç”Ÿæˆè¡¨å•ï¼ˆäººåã€checkboxã€å¤©æ•°ç›‘å¬ç­‰ï¼‰
    seedBillForm();
  
    // å›å¡«å­—æ®µ
    $("billTitle").value = b.title || "";
    $("billAmount").value = (Number(b.amount)||0).toFixed(2).replace(/\.00$/,""); // 1200.00 => 1200
    $("billStart").value = b.start || "";
    $("billEnd").value = b.end || "";
    $("billPayer").value = b.payer || (state.people[0]||"");
    // âœ… å›å¡« tip/subtotal
    const subEl = document.getElementById("billSubtotal");
    if(subEl) subEl.value = (b.subtotal!=null && isFinite(Number(b.subtotal))) ? Number(b.subtotal).toFixed(2) : "";
    
    const tp = isFinite(Number(b.tipPercent)) ? Number(b.tipPercent) : 0;
    const presets = new Set([0,18,20,25]);
    const otherEl = document.getElementById("billTipOther");
    const rOther = document.querySelector('input[name="tipPreset"][value="other"]');
    
    if(presets.has(tp)){
      const r = document.querySelector(`input[name="tipPreset"][value="${tp}"]`);
      if(r) r.checked = true;
      if(otherEl){ otherEl.value = ""; otherEl.disabled = true; }
    }else{
      if(rOther) rOther.checked = true;
      if(otherEl){
        otherEl.disabled = false;
        otherEl.value = String(clamp(tp,0,25));
      }
    }
    // âœ… æ¢å¤â€œåŸºå‡†å°è®¡â€ï¼Œé¿å…ç¼–è¾‘æ—¶åˆ‡å°è´¹é‡å¤å åŠ /é‡‘é¢å˜ç©º
    const amtEl = document.getElementById("billAmount");
    if(amtEl){
      // ä¼˜å…ˆç”¨ b.baseSubtotalï¼›æ²¡æœ‰çš„è¯å† fallback åˆ° subtotalï¼›å†æ²¡æœ‰å°±ç”¨å½“å‰ amount
      const bs =
        (b.baseSubtotal != null && isFinite(Number(b.baseSubtotal))) ? Number(b.baseSubtotal) :
        (b.subtotal != null && isFinite(Number(b.subtotal))) ? Number(b.subtotal) :
        (isFinite(Number(b.amount)) ? Number(b.amount) : 0);
    
      amtEl.dataset.baseSubtotal = String(Math.max(0, bs));
    }
        
    // å›å¡«åï¼šå¦‚æœ subtotal æœ‰å€¼ï¼Œç«‹åˆ»é‡ç®—ä¸€æ¬¡æ€»é¢ï¼ˆå¯é€‰ï¼‰
    recalcBillTotalFromTip();
      
    // è§¦å‘å¤©æ•°åˆ·æ–°
    $("billStart").dispatchEvent(new Event("change"));
    $("billEnd").dispatchEvent(new Event("change"));
  
    // å›å¡«å‚ä¸äººå‹¾é€‰
    const selected = new Set((b.participants||[]).map(p=>p.name));
    [...$("billParticipantsChecks").querySelectorAll('input[type=checkbox]')].forEach(chk=>{
      chk.checked = selected.has(chk.value);
    });
  
    // æ”¹æ ‡é¢˜/æŒ‰é’®
    document.querySelector("#modalBill .modalTitle").textContent = "ç¼–è¾‘è´¦å•";
    $("billSaveBtn").textContent = "ä¿å­˜ä¿®æ”¹";
  
    $("modalBill").style.display="flex";
  }

  // ========= åˆ†æ‘Š/ç»“ç®— =========
  function computeAllocCents(bill){
    const amountC=toCents(bill.amount);
    const ps=bill.participants||[];
    const totalPersonDays = ps.reduce((s,p)=>s+(Number(p.days)||0),0);
    if(amountC<=0 || totalPersonDays<=0 || ps.length===0){
      return { amountC, totalPersonDays, alloc: ps.map(p=>({name:p.name, days:Number(p.days)||0, shareC:0})) };
    }
    const items = ps.map((p,idx)=>{
      const d=Math.max(0, Math.floor(Number(p.days)||0));
      const exact = amountC * (d/totalPersonDays);
      const floorC=Math.floor(exact);
      const rem=exact-floorC;
      return { idx, name:p.name, days:d, floorC, rem };
    });
    let sumFloor=items.reduce((s,x)=>s+x.floorC,0);
    let remaining=amountC-sumFloor;
    items.sort((a,b)=>b.rem-a.rem);
    for(let i=0;i<items.length && remaining>0;i++){
      items[i].floorC += 1; remaining -= 1;
    }
    items.sort((a,b)=>a.idx-b.idx);
    return { amountC, totalPersonDays, alloc: items.map(x=>({name:x.name, days:x.days, shareC:x.floorC})) };
  }

  function computeTotals(){
    const owed=new Map(), paid=new Map();
    state.people.forEach(p=>{ owed.set(p,0); paid.set(p,0); });
    for(const b of state.bills){
      const { amountC, alloc } = computeAllocCents(b);
      if(b.payer) paid.set(b.payer, (paid.get(b.payer)||0) + amountC);
      for(const a of alloc) owed.set(a.name, (owed.get(a.name)||0) + a.shareC);
    }
    const net=new Map();
    const all=new Set([...owed.keys(), ...paid.keys()]);
    for(const name of all) net.set(name, (paid.get(name)||0) - (owed.get(name)||0));
    return { owed, paid, net };
  }

  function computeSettlement(netMap){
    const creditors=[], debtors=[];
    for(const [name,v] of netMap.entries()){
      if(v>0) creditors.push({name, amt:v});
      else if(v<0) debtors.push({name, amt:-v});
    }
    creditors.sort((a,b)=>b.amt-a.amt);
    debtors.sort((a,b)=>b.amt-a.amt);
    const transfers=[];
    let i=0,j=0;
    while(i<debtors.length && j<creditors.length){
      const d=debtors[i], c=creditors[j];
      const x=Math.min(d.amt,c.amt);
      if(x>0){
        transfers.push({from:d.name,to:c.name,amountC:x});
        d.amt-=x; c.amt-=x;
      }
      if(d.amt===0) i++;
      if(c.amt===0) j++;
    }
    return transfers;
  }
  const EXPAND_KEY = "aa_bill_expand_v1";
  const isMobile = () => window.matchMedia("(max-width: 640px)").matches;
  
  let expandedBills = new Set();
  try{
    expandedBills = new Set(JSON.parse(localStorage.getItem(EXPAND_KEY) || "[]"));
  }catch(e){ expandedBills = new Set(); }
  
  function persistExpanded(){
    localStorage.setItem(EXPAND_KEY, JSON.stringify([...expandedBills]));
  }
  
  const BILLS_VIEW_KEY = "aa_bills_view_compact_v1";
  let billsCompact = false;
  try{
    billsCompact = JSON.parse(localStorage.getItem(BILLS_VIEW_KEY) || "false");
  }catch(e){ billsCompact = false; }
  
  function persistBillsCompact(){
    localStorage.setItem(BILLS_VIEW_KEY, JSON.stringify(!!billsCompact));
  }

  const FILTER_KEY = "aa_bill_filter_v1";
  let billFilter = { payer:"", from:"", to:"" };
  try{ billFilter = JSON.parse(localStorage.getItem(FILTER_KEY) || "{}"); }catch(e){}
  billFilter = { payer: billFilter.payer||"", from: billFilter.from||"", to: billFilter.to||"" };
  
  function saveBillFilter(){
    localStorage.setItem(FILTER_KEY, JSON.stringify(billFilter));
  }
  
  function date0(s){ return s ? new Date(s + "T00:00:00") : null; }
  
  // äº¤é›†åˆ¤æ–­ï¼šbill[bs,be] ä¸ filter[fs,fe] æœ‰äº¤é›†
  function inRangeOverlap(b){
    const bs = date0(b.start), be = date0(b.end);
    const fs = date0(billFilter.from), fe = date0(billFilter.to);
    if(!bs || !be) return true;
    if(fs && be < fs) return false;
    if(fe && bs > fe) return false;
    return true;
  }
  
  function getFilteredBills(){
    return state.bills.filter(b=>{
      if(billFilter.payer && b.payer !== billFilter.payer) return false;
      if(!inRangeOverlap(b)) return false;
      return true;
    });
  }
  
function syncFilterUI(){
  const sel = document.getElementById("filterPayer");
  const f1  = document.getElementById("filterFrom");
  const f2  = document.getElementById("filterTo");
  const hint = document.getElementById("filterRangeHint");

  if(!sel) return;

  // 1) ä»˜æ¬¾äººä¸‹æ‹‰ï¼šåªåˆ—å‡ºâ€œè´¦å•é‡Œå‡ºç°è¿‡çš„ä»˜æ¬¾äººâ€
  const payerSet = new Set(
    state.bills.map(b => String(b.payer || "").trim()).filter(Boolean)
  );
  const payers = Array.from(payerSet).sort((a,b)=>a.localeCompare(b,"zh"));

  // è‹¥å½“å‰ç­›é€‰ payer ä¸å­˜åœ¨äº†ï¼Œè‡ªåŠ¨æ¸…ç©º
  if(billFilter.payer && !payerSet.has(billFilter.payer)){
    billFilter.payer = "";
    saveBillFilter();
  }

  sel.innerHTML =
    `<option value="">å…¨éƒ¨ä»˜æ¬¾äºº</option>` +
    payers.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

  sel.value = billFilter.payer || "";

  // 2) æ—¥æœŸèŒƒå›´ï¼šåªç»™â€œæœ‰å€¼èŒƒå›´â€ï¼ˆè‡ªåŠ¨ min/max + æç¤ºï¼‰
  const dates = state.bills
    .filter(b => b.start && b.end)
    .map(b => ({ s: b.start, e: b.end }));

  let minD = "", maxD = "";
  for(const d of dates){
    if(!minD || d.s < minD) minD = d.s;
    if(!maxD || d.e > maxD) maxD = d.e;
  }

  if(f1 && f2){
    if(minD && maxD){
      f1.min = minD; f1.max = maxD;
      f2.min = minD; f2.max = maxD;
      if(hint) hint.textContent = `å¯ç­›é€‰æ—¥æœŸèŒƒå›´ï¼š${minD} ~ ${maxD}`;
    }else{
      f1.min = ""; f1.max = "";
      f2.min = ""; f2.max = "";
      if(hint) hint.textContent = "æš‚æ— å¯ç”¨æ—¥æœŸèŒƒå›´ï¼ˆå…ˆæ·»åŠ å¸¦æ—¥æœŸçš„è´¦å•ï¼‰";
    }

    // å›å¡«ç­›é€‰å€¼
    f1.value = billFilter.from || "";
    f2.value = billFilter.to || "";

    // å¦‚æœç­›é€‰æ—¥æœŸè¶…å‡ºèŒƒå›´ï¼Œè‡ªåŠ¨æ¸…ç©º
    if(minD && maxD){
      let changed = false;
      if(billFilter.from && (billFilter.from < minD || billFilter.from > maxD)){
        billFilter.from = ""; changed = true;
      }
      if(billFilter.to && (billFilter.to < minD || billFilter.to > maxD)){
        billFilter.to = ""; changed = true;
      }
      if(changed){
        saveBillFilter();
        f1.value = billFilter.from || "";
        f2.value = billFilter.to || "";
      }
    }
  }
}

  
  function bindFilterEventsOnce(){
    const sel = document.getElementById("filterPayer");
    const f1 = document.getElementById("filterFrom");
    const f2 = document.getElementById("filterTo");
    const clr = document.getElementById("btnFilterClear");
    if(!sel || sel.dataset.bound) return; // é˜²é‡å¤ç»‘å®š
    sel.dataset.bound = "1";
  
    sel.addEventListener("change", ()=>{
      billFilter.payer = sel.value;
      saveBillFilter();
      renderAll();
    });
    f1.addEventListener("change", ()=>{
      billFilter.from = f1.value || "";
      saveBillFilter();
      renderAll();
    });
    f2.addEventListener("change", ()=>{
      billFilter.to = f2.value || "";
      saveBillFilter();
      renderAll();
    });
    clr?.addEventListener("click", ()=>{
      billFilter = { payer:"", from:"", to:"" };
      saveBillFilter();
      syncFilterUI();
      toast("å·²æ¸…ç©ºç­›é€‰");
      renderAll();
    });
  }  
  function renderBills(){
    const box=$("billsContainer");
    box.innerHTML="";
    const bills = getFilteredBills();
    if(bills.length===0){

      if(state.bills.length===0){
        box.innerHTML=`<div class="hint">è¿˜æ²¡æœ‰è´¦å•ï¼Œç‚¹åº•éƒ¨â€œ+è´¦â€æ·»åŠ ã€‚</div>`;
      }else{
        box.innerHTML=`<div class="hint">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„è´¦å•ã€‚</div>`;
      }
      return;
    }
      // âœ… åˆ—è¡¨æŠ˜å è§†å›¾ï¼šåªæ˜¾ç¤º ä»˜æ¬¾äºº/é‡‘é¢/äººæ•°/å¤©æ•°ï¼ˆç‚¹å‡»å¯å±•å¼€åˆ°å¡ç‰‡è§†å›¾å¹¶å®šä½ï¼‰
    if(billsCompact){
      const table = document.createElement("table");
      table.className = "bill-table";
      table.innerHTML = `
        <thead>
          <tr>
            <th>ä»˜æ¬¾äºº</th>
            <th class="right">é‡‘é¢</th>
            <th class="right">äººæ•°</th>
            <th class="right">å¤©æ•°</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tb = table.querySelector("tbody");
  
      bills.forEach(b=>{
        const billDays = daysInclusive(b.start, b.end);
        const amountC = toCents(b.amount);
        const peopleCount = (b.participants||[]).length;
  
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.innerHTML = `
          <td>
            <div style="font-weight:900">${escapeHtml(b.payer || "")}</div>
            <div class="small muted">${escapeHtml(b.title||"æœªå‘½åè´¦å•")}</div>
          </td>
          <td class="right mono">$${centsToMoney(amountC)}</td>
          <td class="right mono">${peopleCount}</td>
          <td class="right mono">${billDays}</td>
        `;
  
        // ç‚¹å‡»è¡Œï¼šåˆ‡å›å¡ç‰‡è§†å›¾ï¼Œå¹¶è®©è¯¥è´¦å•é»˜è®¤å±•å¼€ + æ»šåŠ¨å®šä½
        tr.addEventListener("click", ()=>{
          billsCompact = false;
          persistBillsCompact();
          renderAll();
          setTimeout(()=>{
            document.getElementById(`bill-${b.id}`)?.scrollIntoView({behavior:"smooth", block:"start"});
          }, 0);
        });
  
        tb.appendChild(tr);
      });
  
      box.appendChild(table);
      return;
    }
    bills.forEach(b=>{
      const billDays=daysInclusive(b.start,b.end);
      const { amountC, totalPersonDays, alloc } = computeAllocCents(b);

    const card=document.createElement("div");
    card.className="card billCard";
    card.style.marginBottom="12px";
    card.id = `bill-${b.id}`;
    
    // âœ… æŒ‰ä»˜æ¬¾äººä¸Šè‰²ï¼ˆæ²¡æœ‰ä»˜æ¬¾äººå°±ç”¨æ ‡é¢˜ï¼‰
    const [a1,a2] = accentForName(b.payer || b.title || "bill");
    card.style.setProperty("--accent1", a1);
    card.style.setProperty("--accent2", a2);

    const payerOptions = state.people.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    const isOpen = expandedBills.has(b.id); // âœ… é»˜è®¤ä¸è‡ªåŠ¨å±•å¼€


      card.innerHTML = `
        <div class="bill-topline">
          <div>
            <div class="billCardHeaderGlow">
              <div style="font-weight:950">${escapeHtml(b.title||"æœªå‘½åè´¦å•")}</div>
              <div class="small muted" style="margin-top:4px">
                é‡‘é¢ï¼š<span class="mono">$${centsToMoney(amountC)}</span> Â·
                æ—¥æœŸï¼š<span class="mono">${escapeHtml(b.start)}</span> ~ <span class="mono">${escapeHtml(b.end)}</span>ï¼ˆ${billDays}å¤©ï¼‰ Â·
                æ€»äººå¤©ï¼š<span class="mono">${totalPersonDays}</span>
              </div>
        
              <div class="row" style="margin-top:8px">
                <span class="badge">ä»˜æ¬¾äºº</span>
                <select data-role="payer" style="min-width:160px">${payerOptions}</select>
                <button class="secondary ghost" data-act="setAll">ä¸€é”®å…¨ç¨‹</button>
              </div>
            </div>
          </div>
      
          <div class="bill-actions">
            <button class="secondary ghost bill-toggle" data-act="toggle">${isOpen ? "æ”¶èµ·" : "å±•å¼€"}</button>
            <button class="secondary ghost" data-act="edit">ç¼–è¾‘</button>
            <button class="secondary ghost" data-act="dup">å¤åˆ¶</button>
            <button class="danger" data-act="del">åˆ é™¤</button>
          </div>
        </div>
      
        <div class="bill-body ${isOpen ? "open" : ""}" data-role="body">
          <div class="hr"></div>
      
          <table class="bill-table">
            <thead>
              <tr>
                <th>å‚ä¸äºº</th>
                <th class="right">å‚ä¸å¤©æ•°</th>
                <th class="right">åº”ä»˜</th>
              </tr>
            </thead>
            <tbody data-role="tb"></tbody>
          </table>
        </div>
      `;


      const payerSel=card.querySelector('[data-role="payer"]');
      payerSel.value=b.payer || state.people[0] || "";
      payerSel.addEventListener("change", ()=>{ b.payer=payerSel.value; touchAndRender(); });

      card.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        state.bills = state.bills.filter(x=>x.id!==b.id);
        touchAndRender("å·²åˆ é™¤è´¦å•");
      });
      card.querySelector('[data-act="dup"]').addEventListener("click", ()=>{
        const copy=JSON.parse(JSON.stringify(b));
        copy.id=uid(); copy.title=(copy.title||"è´¦å•")+"ï¼ˆå¤åˆ¶ï¼‰";
        state.bills.unshift(copy);
        touchAndRender("å·²å¤åˆ¶");
      });
      card.querySelector('[data-act="setAll"]').addEventListener("click", ()=>{
        (b.participants||[]).forEach(pp=>pp.days=billDays);
        touchAndRender("å·²è®¾ç½®å…¨ç¨‹");
      });
      card.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        openEditBill(b.id);
      });

      // âœ… æŠ˜å /å±•å¼€ï¼ˆæ–°å¢ï¼‰
      const bodyBox = card.querySelector('[data-role="body"]');
      const toggleBtn = card.querySelector('[data-act="toggle"]');
      
      toggleBtn.addEventListener("click", ()=>{
        const willOpen = !bodyBox.classList.contains("open");
        bodyBox.classList.toggle("open", willOpen);
        toggleBtn.textContent = willOpen ? "æ”¶èµ·" : "å±•å¼€";
      
        if(willOpen) expandedBills.add(b.id);
        else expandedBills.delete(b.id);
        persistExpanded();
      });

      const tb=card.querySelector('[data-role="tb"]');
      (b.participants||[]).forEach(pp=>{
        const shareC = alloc.find(a=>a.name===pp.name)?.shareC ?? 0;
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td style="font-weight:900">${escapeHtml(pp.name)}</td>
          <td class="right">
            <input type="number" min="0" step="1"
              value="${Math.max(0, Math.floor(Number(pp.days)||0))}"
              class="bill-days-input" />
            <div class="bill-suggest">å»ºè®®ï¼š${billDays}</div>
          </td>
          <td class="right mono">$${centsToMoney(shareC)}</td>
        `;
        const inp=tr.querySelector("input");
        inp.addEventListener("input", ()=>{
          pp.days = Math.max(0, Math.floor(Number(inp.value)||0));
          touchAndRender();
        });
        tb.appendChild(tr);
      });

      box.appendChild(card);
    });
  }

  function renderSummary(){
    const { owed, paid, net } = computeTotals();
    const names=Array.from(new Set([...state.people, ...net.keys()]));
    const rows=names.map(name=>({
      name, owedC:owed.get(name)||0, paidC:paid.get(name)||0, netC:net.get(name)||0
    })).sort((a,b)=>b.netC-a.netC);

    const body=$("summaryBody");
    body.innerHTML="";
    if(rows.length===0){
      body.innerHTML=`<tr><td class="muted" colspan="4">æš‚æ— æ•°æ®</td></tr>`;
    }else{
      rows.forEach(r=>{
        const cls = r.netC>0 ? "ok" : (r.netC<0 ? "no" : "muted");
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td style="font-weight:900">${escapeHtml(r.name)}</td>
          <td class="right mono">$${centsToMoney(r.owedC)}</td>
          <td class="right mono">$${centsToMoney(r.paidC)}</td>
          <td class="right mono ${cls}">$${centsToMoney(r.netC)}</td>
        `;
        body.appendChild(tr);
      });
    }

    const transfers=computeSettlement(net);
    const sb=$("settleBody");
    sb.innerHTML="";
    if(transfers.length===0){
      sb.innerHTML=`<tr><td class="muted" colspan="3">æš‚æ— éœ€è¦è½¬è´¦</td></tr>`;
    }else{
      transfers.forEach(t=>{
        const tr=document.createElement("tr");
          tr.innerHTML=`
            <td style="font-weight:900">${escapeHtml(t.from)}</td>
            <td style="font-weight:900">${escapeHtml(t.to)}</td>
            <td class="right mono">$${centsToMoney(t.amountC)}</td>
          `;
        sb.appendChild(tr);
      });
    }
  }

  function renderAll(){
    renderPeople();
    renderBills();
    renderSummary();
    syncFilterUI();
    bindFilterEventsOnce();
  }

  // ========= JSON å¤‡ä»½ =========
  function exportJSONToBox(){ $("jsonBox").value = JSON.stringify(state,null,2); toast("å·²å¯¼å‡ºåˆ°æ–‡æœ¬æ¡†"); }
function importJSONFromBox(){
  try{
    const txt = $("jsonBox").value.trim();
    if(!txt){ toast("è¯·å…ˆç²˜è´´ JSON"); return; }

    const obj = JSON.parse(txt);
    if(!obj || !Array.isArray(obj.people) || !Array.isArray(obj.bills)){
      toast("JSONç»“æ„ä¸å¯¹"); 
      return;
    }

    state.people = obj.people.map(String).filter(Boolean);

    state.bills = obj.bills.map(b=>({
      id: b.id || uid(),
      title: String(b.title || "è´¦å•"),
      amount: isFinite(Number(b.amount)) ? Math.max(0, Number(b.amount)) : 0,
      start: b.start || "",
      end: b.end || "",
      payer: String(b.payer || ""),

      // âœ… å‚ä¸äºº
      participants: Array.isArray(b.participants)
        ? b.participants.map(p=>({
            name: String(p.name || ""),
            days: Math.max(0, Math.floor(Number(p.days) || 0))
          })).filter(p=>p.name)
        : [],

      // âœ… tip ç›¸å…³ä¸‰ä¸ªå­—æ®µï¼ˆæ”¾è¿™é‡Œæ‰å¯¹ï¼‰
      subtotal: (b.subtotal!=null && isFinite(Number(b.subtotal))) ? Math.max(0, Number(b.subtotal)) : null,
      tipPercent: (b.tipPercent!=null && isFinite(Number(b.tipPercent))) ? clamp(Number(b.tipPercent),0,25) : 0,
      baseSubtotal: (b.baseSubtotal!=null && isFinite(Number(b.baseSubtotal))) ? Math.max(0, Number(b.baseSubtotal)) : null,
    }));

    touchAndRender("å¯¼å…¥æˆåŠŸ");
  }catch(e){
    toast("å¯¼å…¥å¤±è´¥ï¼š"+e.message);
  }
}

  function exportJSON(){ openModal("share"); exportJSONToBox(); }
  function clearAll(){
    if(!confirm("ç¡®è®¤æ¸…ç©ºå…¨éƒ¨äººå‘˜å’Œè´¦å•ï¼Ÿ")) return;
    state={people:[], bills:[]};
    touchAndRender("å·²æ¸…ç©º");
  }

  // ========= Firebase çœŸåä½œï¼ˆåŠ å¯†ï¼‰ =========
  let app=null, auth=null, db=null;
  let clientId = localStorage.getItem("aa_client_id") || uid();
  localStorage.setItem("aa_client_id", clientId);

  let roomId="";
  let passcode="";
  let passHash="";
  let unsubRoom=null;

  let localVersion=0;
  let lastRemoteVersion=0;
  let pushing=false;
  let pushTimer=null;

  function setSyncBadge(text){ $("syncBadge").textContent=text; }
  function refreshCollabUI(){
    $("roomIdBox").value = roomId || "";
    $("inviteLinkBox").value = roomId ? inviteLink(roomId) : "";
  }

  async function ensureFirebase(){
    if(app) return;
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }
  async function ensureAuth(){
    await signInAnonymously(auth);
    await new Promise((resolve)=> {
      const off = onAuthStateChanged(auth, (u)=>{ if(u){ off(); resolve(); } });
    });
  }

  function friendlyErr(e){
    const msg = String(e?.message || e || "unknown");
    if(msg.includes("auth/unauthorized-domain")) return "Firebase æœªæˆæƒåŸŸåï¼šè¯·åœ¨ Firebase Auth é‡Œæ·»åŠ  hxyder.github.io";
    if(msg.includes("permission-denied")) return "Firestore Rules æ‹’ç»å†™å…¥ï¼šæ£€æŸ¥ Rules æ˜¯å¦æŒ‰è¦æ±‚å‘å¸ƒ";
    return msg;
  }

  async function connectRoom(room, pass){
    try{
      if(!room){ toast("room ä¸èƒ½ä¸ºç©º"); return false; }
      if(!isSixDigits(pass)){ toast("å£ä»¤å¿…é¡»æ˜¯ 6 ä½æ•°å­—"); return false; }

      await ensureFirebase();
      await ensureAuth();

      roomId = room;
      passcode = pass;
      passHash = await sha256Hex(passcode);

      setRoomToUrl(roomId);
      refreshCollabUI();
      setSyncBadge(`è¿æ¥ä¸­ï¼šroom=${roomId}`);

      storePass(roomId, passcode);

      if(unsubRoom) unsubRoom();

      const roomRef = doc(db, "rooms", roomId);
      const snap = await getDoc(roomRef);

      if(snap.exists()){
        const data = snap.data();
        if(String(data.passHash||"") !== passHash){
          setSyncBadge("å£ä»¤é”™è¯¯ï¼šæ— æ³•åŠ å…¥");
          toast("å£ä»¤é”™è¯¯ï¼šæ— æ³•åŠ å…¥è¯¥æˆ¿é—´");
          roomId=""; passcode=""; passHash="";
          refreshCollabUI();
          return false;
        }

        try{
          if(data.cipher && data.iv){
            const remoteState = await decryptState(data.cipher, data.iv, passcode, roomId);
            state = remoteState;
            saveLocal();
            renderAll();
          }
        }catch(e){
          setSyncBadge("è§£å¯†å¤±è´¥ï¼šå£ä»¤ä¸å¯¹æˆ–æ•°æ®æŸå");
          toast("è§£å¯†å¤±è´¥ï¼šå£ä»¤ä¸å¯¹æˆ–æ•°æ®æŸå");
          roomId=""; passcode=""; passHash="";
          refreshCollabUI();
          return false;
        }
      }else{
        // æ–°æˆ¿é—´ï¼šç”¨æœ¬åœ° state åˆå§‹åŒ–
        const enc = await encryptState(state, passcode, roomId);
        await setDoc(roomRef, {
          passHash,
          cipher: enc.cipher,
          iv: enc.iv,
          version: localVersion,
          updatedAt: serverTimestamp(),
          updatedBy: clientId,
        }, { merge:false });
      }

      // ç›‘å¬è¿œç«¯å˜æ›´
      unsubRoom = onSnapshot(roomRef, async (s)=>{
        const data = s.data();
        if(!data) return;
        if(String(data.passHash||"") !== passHash) return;

        const v = Number(data.version || 0);
        const by = String(data.updatedBy || "");
        if(!data.cipher || !data.iv) return;

        if(by === clientId){
          lastRemoteVersion = Math.max(lastRemoteVersion, v);
          return;
        }

        if(v > lastRemoteVersion && v >= localVersion){
          try{
            const remoteState = await decryptState(data.cipher, data.iv, passcode, roomId);
            lastRemoteVersion = v;
            localVersion = v;
            state = remoteState;
            saveLocal();
            renderAll();
            setSyncBadge(`å·²åŒæ­¥ï¼šroom=${roomId}`);
          }catch(e){
            setSyncBadge("åŒæ­¥åˆ°çš„å†…å®¹æ— æ³•è§£å¯†ï¼ˆå£ä»¤ä¸åŒ¹é…ï¼Ÿï¼‰");
          }
        }
      });

      setSyncBadge(`å·²åŒæ­¥ï¼šroom=${roomId}`);
      return true;

    }catch(e){
      const m = friendlyErr(e);
      setSyncBadge("è¿æ¥å¤±è´¥ï¼š" + m);
      toast("è¿æ¥å¤±è´¥ï¼š" + m);
      console.error(e);
      return false;
    }
  }

  function schedulePush(){
    if(!roomId || !db || !passcode) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(pushNow, 650);
  }

  async function pushNow(){
    if(!roomId || !db || !passcode) return;
    if(pushing) return;
    pushing = true;

    try{
      const roomRef = doc(db, "rooms", roomId);
      const enc = await encryptState(state, passcode, roomId);

      await setDoc(roomRef, {
        passHash,
        cipher: enc.cipher,
        iv: enc.iv,
        version: localVersion,
        updatedAt: serverTimestamp(),
        updatedBy: clientId,
      }, { merge:true });

      setSyncBadge(`å·²åŒæ­¥ï¼šroom=${roomId}`);
    }catch(e){
      const m = friendlyErr(e);
      setSyncBadge("åŒæ­¥å¤±è´¥ï¼š" + m);
      toast("åŒæ­¥å¤±è´¥ï¼š" + m);
      console.error(e);
    }finally{
      pushing = false;
    }
  }

  function touchAndRender(msg){
    localVersion += 1;
    saveLocal();
    renderAll();
    if(msg) toast(msg);
    schedulePush();
  }

  async function createNewRoom(){
    const pass = $("createPassInput").value.trim();
    if(!isSixDigits(pass)){ toast("è¯·åœ¨â€œæ–°æˆ¿é—´å£ä»¤â€é‡Œè¾“å…¥ 6 ä½æ•°å­—"); return; }
    const rid = roomIdRandom();
    const ok = await connectRoom(rid, pass);
    if(ok){
      refreshCollabUI();
      toast("åˆ›å»ºæˆåŠŸï¼ˆå·²è¿›å…¥æˆ¿é—´ï¼‰");
      closeModal("share");
    }
  }

  async function joinRoom(){
    const rid = $("joinRoomInput").value.trim();
    const pass = $("joinPassInput").value.trim();
    if(!rid){ toast("è¯·è¾“å…¥ room"); return; }
    if(!isSixDigits(pass)){ toast("å£ä»¤å¿…é¡»æ˜¯ 6 ä½æ•°å­—"); return; }

    const ok = await connectRoom(rid, pass);
    if(ok){
      $("joinRoomInput").value="";
      $("joinPassInput").value="";
      refreshCollabUI();
      toast("è¿›å…¥æˆåŠŸ");
      closeModal("share");
    }
  }

  async function copyInviteLink(){
    if(!roomId){ toast("è¿˜æ²¡è¿›å…¥æˆ¿é—´"); return; }
    const link = inviteLink(roomId);
    try{
      await navigator.clipboard.writeText(link);
      toast("å·²å¤åˆ¶é‚€è¯·é“¾æ¥ï¼ˆå£ä»¤è¯·å¦å‘ï¼‰");
    }catch(e){
      $("inviteLinkBox").focus();
      $("inviteLinkBox").select();
      toast("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶");
    }
  }

  // ========= å…¨å±€ç»‘å®šï¼ˆè§£å†³â€œç‚¹æŒ‰é’®æ²¡ååº”â€ï¼‰ =========
window.openModal = openModal;
window.closeModal = closeModal;
window.addPerson = addPerson;
window.openEditBill = openEditBill;
window.createBill = createBill;
window.exportJSON = exportJSON;
window.exportJSONToBox = exportJSONToBox;
window.importJSONFromBox = importJSONFromBox;
window.clearAll = clearAll;
window.createNewRoom = createNewRoom;
window.joinRoom = joinRoom;
window.copyInviteLink = copyInviteLink;
window.saveAiToken = saveAiToken;
window.clearAiToken = clearAiToken;
window.seedAiContext = seedAiContext;
window.sendAi = sendAi;
window.openAiEntry = openAiEntry;
window.scanInvoices = scanInvoices;
window.bindInvoiceInputOnce = bindInvoiceInputOnce;
window.applyInvoiceToBillForm = applyInvoiceToBillForm;
window.removeInvoice = removeInvoice;
window.showOcrText = showOcrText;
window.updateInvoiceField = updateInvoiceField;
window.pickInvoices = pickInvoices;
window.clearInvoiceDrafts = clearInvoiceDrafts;
window.prevInvoice = prevInvoice;
window.nextInvoice = nextInvoice;
window.renderInvoicePager = renderInvoicePager;

  // ========= åˆå§‹åŒ– =========
  loadLocal();
  renderAll();
  bindInvoiceInputOnce();
  setActiveTab(activeTab);
  document.getElementById("btnBillsCompact")?.addEventListener("click", ()=>{
    billsCompact = true;
    persistBillsCompact();
    toast("å·²æŠ˜å ä¸ºåˆ—è¡¨è§†å›¾");
    renderAll();
  });
  
  document.getElementById("btnBillsExpand")?.addEventListener("click", ()=>{
    billsCompact = false;
    persistBillsCompact();
    toast("å·²å±•å¼€ä¸ºå¡ç‰‡è§†å›¾");
    renderAll();
  });

  // URL å¸¦ roomï¼šè‡ªåŠ¨æ‰“å¼€åˆ†äº«å¼¹çª—å¹¶å¡«å¥½ room
  const urlRoom = getRoomFromUrl();
  if(urlRoom){
    setSyncBadge("æ£€æµ‹åˆ°æˆ¿é—´å·ï¼šè¯·è¾“å…¥å£ä»¤åŠ å…¥");
    // è‡ªåŠ¨å¼¹å‡ºåä½œçª—å£ï¼Œç›´æ¥è®©ç”¨æˆ·è¾“å£ä»¤
    setTimeout(()=> openModal("share"), 250);

    // å¦‚æœæœ¬æœºè®°ä½å£ä»¤ï¼Œå°è¯•è‡ªåŠ¨åŠ å…¥ï¼ˆåŒä¸€è®¾å¤‡ï¼‰
    const sp = getStoredPass(urlRoom);
    if(sp && isSixDigits(sp)){
      setTimeout(async ()=>{
        const ok = await connectRoom(urlRoom, sp);
        if(ok){ toast("å·²è‡ªåŠ¨é‡è¿æˆåŠŸ"); }
      }, 600);
    }
  }else{
    setSyncBadge("ç¦»çº¿ï¼šä»…æœ¬æœºä¿å­˜ï¼ˆç‚¹â€œåä½œ/åˆ†äº«â€åˆ›å»º/åŠ å…¥ï¼‰");
  }

  refreshCollabUI();
  refreshAiTokenStatus();

</script>
</body>
</html>





