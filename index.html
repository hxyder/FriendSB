<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>牛逼人分牛逼钱·（6位口令加密）</title>
  <style>
  :root{
    --bg:#f6f7ff;
    --card:#ffffff;
    --text:#12162a;
    --muted:#5b6b96;
    --line:rgba(18,22,42,.10);

    /* Brand accents */
    --pri:#3b5cff;     /* blue */
    --pri2:#b24bff;    /* purple */
    --cyan:#12c2ff;    /* cyan */
    --orange:#ff9f2f;  /* orange */
    --green:#14b86a;   /* green */
    --pink:#ff3b7a;    /* pink */

    --good:#14b86a;
    --bad:#ff3b7a;

    --shadow:0 12px 28px rgba(18,22,42,.12);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial;
    color:var(--text);
    background:
      radial-gradient(1100px 700px at 12% -6%, rgba(59,92,255,.24), transparent 60%),
      radial-gradient(900px 650px at 98% 4%, rgba(178,75,255,.20), transparent 60%),
      radial-gradient(900px 650px at 45% 110%, rgba(18,194,255,.14), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.80), rgba(246,247,255,1)),
      var(--bg);
  }

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.82);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .top{
    max-width:1100px; margin:0 auto; padding:12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .title{font-weight:950}
  .sub{font-size:12px; color:var(--muted); margin-top:4px}
  .rightTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

  .badge{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(59,92,255,.22);
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
    color:#1b2140;
    white-space:nowrap;
  }

  .wrap{max-width:1100px; margin:0 auto; padding:14px 14px 96px}
  .grid{display:grid; gap:12px}
  @media(min-width:980px){ .grid{grid-template-columns: 360px 1fr;} }

  .card{
    background:var(--card);
    border:1px solid rgba(18,22,42,.10);
    border-radius:18px;
    padding:12px;
    box-shadow:var(--shadow);
  }

  h2{margin:0 0 10px; font-size:14px; color:#1b2140}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .hr{height:1px; background:var(--line); margin:12px 0}

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid rgba(18,22,42,.10);
    background: rgba(255,255,255,.92);
  }
  th, td{
    padding:10px 10px;
    border-bottom:1px solid rgba(18,22,42,.08);
    font-size:12px;
    text-align:left;
    vertical-align:top;
  }
  th{
    color:#1b2140;
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
  }
  tbody tr:nth-child(even){ background: rgba(59,92,255,.03); }
  .right{text-align:right}
  .ok{color:var(--good); font-weight:950}
  .no{color:var(--bad); font-weight:950}

  .pills{display:flex; flex-wrap:wrap; gap:8px}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid rgba(59,92,255,.18);
    background: linear-gradient(90deg, rgba(59,92,255,.08), rgba(18,194,255,.06));
    font-size:12px;
  }
  .pill b{font-weight:950}
  .pill .x{cursor:pointer; opacity:.75}
  .pill .x:hover{opacity:1}

  /* ===== Buttons base + interaction ===== */
  button{
    border:none;
    cursor:pointer;
    color:white;
    border-radius:14px;
    padding:10px 12px;
    font-weight:950;
    background: linear-gradient(90deg, rgba(59,92,255,.98), rgba(178,75,255,.96));
    box-shadow: 0 10px 22px rgba(59,92,255,.22);
    transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
  }
  button:hover{
    filter: brightness(1.04);
    box-shadow: 0 12px 26px rgba(59,92,255,.26);
  }
  button:active{
    transform: translateY(1px);
    filter: brightness(.98);
  }

  /* Secondary: light but still colorful */
  button.secondary{
    color:var(--text);
    background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
    border:1px solid rgba(18,22,42,.12);
    font-weight:900;
    box-shadow: 0 10px 22px rgba(18,22,42,.06);
  }
  button.secondary:hover{
    box-shadow: 0 12px 26px rgba(18,22,42,.08);
  }

  /* Ghost: subtle colored outline on hover */
  button.ghost{
    color:var(--text);
    background: rgba(255,255,255,.55);
    border:1px solid rgba(18,22,42,.14);
    font-weight:900;
    box-shadow:none;
  }
  button.ghost:hover{
    background: rgba(59,92,255,.08);
    border-color: rgba(59,92,255,.28);
  }

  /* Danger: vivid */
  button.danger{
    color:white;
    background: linear-gradient(90deg, rgba(255,59,122,.98), rgba(255,159,47,.92));
    border:none;
    font-weight:950;
    box-shadow: 0 10px 22px rgba(255,59,122,.18);
  }
  button.danger:hover{
    box-shadow: 0 12px 26px rgba(255,59,122,.22);
  }

  /* Bottom bar */
  .bottomBar{
    position:fixed; left:0; right:0; bottom:0; z-index:20;
    background:rgba(255,255,255,.90);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(18,22,42,.10);
  }
  .bottomInner{
    max-width:1100px; margin:0 auto;
    padding:10px 12px;
    display:flex; gap:10px;
  }
  .bottomInner button{
    flex:1;
    padding:12px 10px;
    border-radius:16px;
  }
  /* ===== Action buttons per bill ===== */
  button[data-act="toggle"]{
    background: linear-gradient(90deg, rgba(18,194,255,.95), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(18,194,255,.18);
    color:white;
    border:none;
  }
  button[data-act="edit"]{
    background: linear-gradient(90deg, rgba(59,92,255,.95), rgba(178,75,255,.92));
    box-shadow: 0 10px 22px rgba(178,75,255,.16);
    color:white;
    border:none;
  }
  button[data-act="dup"]{
    background: linear-gradient(90deg, rgba(255,159,47,.92), rgba(255,59,122,.88));
    box-shadow: 0 10px 22px rgba(255,159,47,.14);
    color:white;
    border:none;
  }
  button[data-act="setAll"]{
    background: linear-gradient(90deg, rgba(20,184,106,.90), rgba(18,194,255,.86));
    box-shadow: 0 10px 22px rgba(20,184,106,.14);
    color:white;
    border:none;
  }

  /* ===== Function-colored buttons (no new classes needed) =====
     By targeting your existing bottom buttons order:
     1) +人  2) +账  3) 协作  4) 导出
  */
  .bottomInner button:nth-child(1){
    background: linear-gradient(90deg, rgba(18,194,255,.98), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(18,194,255,.20);
    color:white;
  }
  .bottomInner button:nth-child(2){
    background: linear-gradient(90deg, rgba(178,75,255,.98), rgba(59,92,255,.92));
    box-shadow: 0 10px 22px rgba(178,75,255,.20);
    color:white;
  }
  .bottomInner button:nth-child(3){
    /* your 3rd is secondary now, make it still colorful */
    background: linear-gradient(90deg, rgba(255,159,47,.18), rgba(255,255,255,.86));
    border:1px solid rgba(255,159,47,.30);
    color: #1b2140;
    box-shadow: 0 10px 22px rgba(255,159,47,.10);
  }
  .bottomInner button:nth-child(4){
    background: linear-gradient(90deg, rgba(20,184,106,.18), rgba(255,255,255,.86));
    border:1px solid rgba(20,184,106,.28);
    color: #1b2140;
    box-shadow: 0 10px 22px rgba(20,184,106,.10);
  }
  .bottomInner button:nth-child(5){
    background: linear-gradient(90deg, rgba(255,59,122,.18), rgba(255,255,255,.86));
    border:1px solid rgba(255,59,122,.30);
    color:#1b2140;
    box-shadow: 0 10px 22px rgba(255,59,122,.10);
  }

  /* Modal center */
  .modalMask{
    position:fixed; inset:0; z-index:30;
    background: rgba(18,22,42,.35);
    display:none; align-items:center; justify-content:center;
    padding:14px;
  }
  .modal{
    width:min(720px, 100%);
    max-height: 86vh;
    overflow:auto;
    background: rgba(255,255,255,.92);
    border:1px solid rgba(18,22,42,.10);
    border-radius:18px;
    box-shadow: 0 24px 60px rgba(18,22,42,.22);
  }
  .modalHeader{
    padding:12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom:1px solid rgba(18,22,42,.10);
    position:sticky; top:0;
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(8px);
  }
  .modalTitle{font-weight:950}
  .modalBody{padding:12px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  label{font-size:12px; color:var(--muted)}
  input, select, textarea{
    border-radius:14px; border:1px solid rgba(18,22,42,.12);
    background: rgba(255,255,255,.98);
    color:var(--text);
    padding:11px 10px;
    outline:none;
    width:100%;
    transition: box-shadow .12s ease, border-color .12s ease;
  }
  input:focus, select:focus, textarea:focus{
    border-color: rgba(59,92,255,.45);
    box-shadow: 0 0 0 4px rgba(59,92,255,.12);
  }
  input[type="date"]{max-width:240px}
  input[type="number"]{max-width:240px}
  .col2{display:grid; gap:10px}
  @media(min-width:640px){ .col2{grid-template-columns:1fr 1fr;} }

  .checkList{display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px}
  @media(min-width:640px){ .checkList{grid-template-columns:1fr 1fr;} }
  .checkItem{
    display:flex; align-items:center; gap:10px;
    padding:10px; border-radius:14px;
    border:1px solid rgba(59,92,255,.16);
    background: linear-gradient(90deg, rgba(59,92,255,.08), rgba(18,194,255,.06));
  }
  .checkItem input{width:auto}
  .hint{font-size:12px; color:var(--muted); line-height:1.6}

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:86px; z-index:50;
    background:rgba(18,22,42,.92);
    color:white;
    border:1px solid rgba(255,255,255,.22);
    padding:10px 12px;
    border-radius:999px;
    display:none;
    font-size:12px;
    max-width:min(92vw, 560px);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(18,22,42,.06);
    border:1px solid rgba(18,22,42,.10);
  }

  /* ===== Bill collapse + prettier table ===== */
  .bill-topline{
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-start;
  }
  .bill-actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .bill-toggle{
    padding:8px 10px;
    border-radius:999px;
  }
  .bill-body{ margin-top:10px; display:none; }
  .bill-body.open{ display:block; }

  .bill-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:14px;
    border:1px solid rgba(18,22,42,.10);
    background:rgba(255,255,255,.95);
  }
  .bill-table thead th{
    background: linear-gradient(90deg, rgba(59,92,255,.10), rgba(178,75,255,.08));
    border-bottom:1px solid rgba(18,22,42,.10);
  }
  .bill-table th, .bill-table td{ padding:10px 10px; font-size:12px; }
  .bill-table tbody tr:nth-child(even){ background: rgba(59,92,255,.03); }

  .bill-days-input{
    width:100px;
    text-align:right;
    border-radius:12px;
    padding:9px 10px;
  }
  .bill-suggest{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }
  /* ===== Bill card accent ===== */
  .billCard{
    position:relative;
    overflow:hidden;
  }
  .billCard::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width:6px;
    background: linear-gradient(180deg, var(--accent1), var(--accent2));
    opacity:.95;
  }
  .billCardHeaderGlow{
    background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0)),
                linear-gradient(90deg, color-mix(in srgb, var(--accent1) 14%, transparent),
                                     color-mix(in srgb, var(--accent2) 10%, transparent));
    border-radius:14px;
    padding:10px;
  }

  /* ===== Tabs for 账单/汇总/结算 ===== */
  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabBtn{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(18,22,42,.14);
    background: rgba(255,255,255,.85);
    color: var(--text);
    font-weight:950;
    cursor:pointer;
    box-shadow:none;
    transition: background .12s ease, border-color .12s ease;
  }
  .tabBtn:hover{
    background: rgba(59,92,255,.08);
    border-color: rgba(59,92,255,.28);
  }
  .tabBtn.active{
    border-color: rgba(59,92,255,.35);
    background: linear-gradient(90deg, rgba(59,92,255,.14), rgba(178,75,255,.10));
  }
  .tabPanel{ display:none; }
  .tabPanel.active{ display:block; }
  /* ===== AI chat bubbles ===== */
  .ai-bubble{
    max-width: 92%;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,.92);
    box-shadow: 0 10px 22px rgba(18,22,42,.10);
    line-height: 1.55;
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .ai-user{ align-self:flex-end; background: rgba(75,107,255,.12); border-color: rgba(75,107,255,.25); }
  .ai-assistant{ align-self:flex-start; background: rgba(162,75,255,.10); border-color: rgba(162,75,255,.22); }
      
</style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <div class="title">牛逼人分牛逼钱· 真协作（6位口令加密）</div>
      <div class="sub">邀请链接带 room · 记得设置密码</div>
    </div>
    <div class="rightTop">
      <div class="badge" id="syncBadge">离线：仅本机保存</div>
      <button class="secondary" onclick="openModal('share')">邀请 / 分享</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>人员</h2>
      <div class="pills" id="peoplePills"></div>

      <div class="hr"></div>

      <h2>工具</h2>
      <div class="row">
        <button class="secondary" onclick="openModal('person')">添加人员</button>
        <button class="secondary" onclick="openModal('bill')">添加账单</button>
        <button class="secondary" onclick="exportJSON()">导出</button>
      </div>

      <div class="hr"></div>

      <h2>说明</h2>
      <div class="hint">
        - 云端存的是<strong>加密后的密文</strong>：没 6 位口令看不到金额。<br/>
        - 写入需要口令校验（Rules 比对 passHash），防止别人篡改。<br/>
        - 链接里带 <span class="kbd">?room=xxxx</span>，房间号会自动填入加入框。
      </div>
    </div>

    <div class="card">
    
      <!-- Tabs -->
      <div class="tabs" id="mainTabs">
        <button class="tabBtn" data-tab="bills">账单列表</button>
        <button class="tabBtn" data-tab="summary">每人汇总</button>
        <button class="tabBtn" data-tab="settle">最终结算</button>
      </div>
    
      <!-- Panel: Bills -->
      <div class="tabPanel" id="panelBills">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">账单列表</h2>
          <div class="row" style="gap:8px">
            <button class="secondary ghost" id="btnBillsCompact">折叠列表</button>
            <button class="secondary ghost" id="btnBillsExpand">展开列表</button>
          </div>
        </div>
        <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid var(--line); background:rgba(255,255,255,.75); margin-top:10px">
          <div class="col2">
            <div>
              <label>筛选付款人</label>
              <select id="filterPayer"></select>
            </div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button class="secondary" id="btnFilterClear">清空筛选</button>
            </div>
            <div>
              <label>开始日期（可不填）</label>
              <input id="filterFrom" type="date" />
            </div>
            <div>
              <label>结束日期（可不填）</label>
              <input id="filterTo" type="date" />
            </div>
          </div>
          <div class="hint" style="margin-top:8px">
            日期筛选按“与账单日期区间有交集”判断（更符合跨天账单）。
          </div>
        </div>        
        <div id="billsContainer"></div>
      </div>
    
      <!-- Panel: Summary -->
      <div class="tabPanel" id="panelSummary">
        <h2>每人汇总（应付/实付/净额）</h2>
        <table>
          <thead>
            <tr>
              <th>人员</th>
              <th class="right">应付</th>
              <th class="right">实付</th>
              <th class="right">净额</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </div>
    
      <!-- Panel: Settlement -->
      <div class="tabPanel" id="panelSettle">
        <h2>最终结算（抵消后最少转账）</h2>
        <table>
          <thead>
            <tr>
              <th>付款人</th>
              <th>收款人</th>
              <th class="right">金额</th>
            </tr>
          </thead>
          <tbody id="settleBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="bottomBar">
  <div class="bottomInner">
    <button onclick="openModal('person')">+ 人</button>
    <button onclick="openModal('bill')">+ 账</button>
    <button class="secondary" onclick="openModal('share')">协作</button>
    <button class="secondary" onclick="exportJSON()">导出</button>
    <button class="secondary" onclick="openAiEntry()">AI</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Modal: Add Person -->
<div class="modalMask" id="modalPerson">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">添加人员</div>
      <button class="ghost" onclick="closeModal('person')">关闭</button>
    </div>
    <div class="modalBody">
      <label>姓名</label>
      <input id="personName" placeholder="例如：A / B / C" />
      <div class="row" style="margin-top:12px">
        <button onclick="addPerson()">添加</button>
        <button class="secondary" onclick="closeModal('person')">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Bill -->
<div class="modalMask" id="modalBill">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">添加账单</div>
      <button class="ghost" onclick="closeModal('bill')">关闭</button>
    </div>
    <div class="modalBody">
      <div class="col2">
        <div>
          <label>账单名称</label>
          <input id="billTitle" placeholder="例如：房租 / 水电 / 网费" />
        </div>
        <div>
          <label>金额（总额）</label>
          <input id="billAmount" type="number" min="0" step="0.01" placeholder="例如：1200" />
        </div>
        <div>
          <label>开始日期</label>
          <input id="billStart" type="date" />
        </div>
        <div>
          <label>结束日期（含当日）</label>
          <input id="billEnd" type="date" />
        </div>
        <div>
          <label>付款人（谁垫付）</label>
          <select id="billPayer"></select>
        </div>
        <div>
          <label>账单天数（自动）</label>
          <input id="billDays" disabled />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>参与人（手机勾选）</label>
        <div class="checkList" id="billParticipantsChecks"></div>
        <div class="hint" style="margin-top:8px">
          创建后默认每人参与天数=账单天数；可在账单卡片里改参与天数。
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="billSaveBtn" onclick="createBill()">创建</button>
        <button class="secondary" onclick="closeModal('bill')">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Share -->
<div class="modalMask" id="modalShare">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">协作 / 分享（6位口令）</div>
      <button class="ghost" onclick="closeModal('share')">关闭</button>
    </div>
    <div class="modalBody">

      <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid var(--line); background:rgba(75,107,255,.04)">
        <div style="font-weight:950">当前房间</div>
        <div class="hint" style="margin-top:6px">
          - 邀请链接只带 <span class="kbd">room</span>，口令请你单独发给对方（群里/私聊）。<br/>
          - 加入成功后弹窗会自动关闭，并提示“进入成功”。
        </div>

        <div class="hr"></div>

        <div class="col2">
          <div>
            <label>当前 room</label>
            <input id="roomIdBox" readonly />
          </div>
          <div>
            <label>邀请链接</label>
            <input id="inviteLinkBox" readonly />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="copyInviteLink()">复制邀请链接</button>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950">创建新房间</div>
        <div class="col2" style="margin-top:10px">
          <div>
            <label>新房间口令（6位数字）</label>
            <input id="createPassInput" inputmode="numeric" maxlength="6" placeholder="例如：123456" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button onclick="createNewRoom()">创建</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950">加入已有房间</div>
        <div class="col2" style="margin-top:10px">
          <div>
            <label>room（会自动从链接填入）</label>
            <input id="joinRoomInput" placeholder="例如：b7k2p9xq" />
          </div>
          <div>
            <label>6位口令</label>
            <input id="joinPassInput" inputmode="numeric" maxlength="6" placeholder="例如：123456" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="joinRoom()">加入</button>
        </div>

        <div class="hint" style="margin-top:10px">
          小提示：如果你刷新页面，系统会尝试从本机记住的口令自动重连（同一台设备有效）。
        </div>
        <div class="hr"></div>

        <div style="font-weight:950">AI（仅你本人使用）</div>
        <div class="hint" style="margin-top:6px">
          - APP_TOKEN 只保存在你本机浏览器（localStorage），不会同步到 Firebase。<br/>
          - 不要把 APP_TOKEN 写进 GitHub 代码或发给别人。
        </div>
        
        <div class="col2" style="margin-top:10px">
          <div>
            <label>APP_TOKEN（本机保存）</label>
            <input id="aiTokenInput" type="password" placeholder="粘贴你的 APP_TOKEN" />
            <div class="hint" id="aiTokenStatus" style="margin-top:6px"></div>
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="secondary" onclick="saveAiToken()">保存</button>
            <button class="danger" onclick="clearAiToken()">清除</button>
          </div>
        </div>
        
        <div class="row" style="margin-top:10px">
          <button onclick="openModal('ai')">打开 AI 聊天</button>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div style="font-weight:950">备份 / 导入（可选）</div>
        <div class="hint">用于手动备份或迁移。</div>
        <div style="margin-top:10px">
          <label>JSON</label>
          <textarea id="jsonBox" rows="8" placeholder="点“导出”生成；或粘贴 JSON 点“导入”"></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="secondary" onclick="exportJSONToBox()">导出到文本框</button>
          <button class="secondary" onclick="importJSONFromBox()">从文本框导入</button>
          <button class="danger" onclick="clearAll()">清空全部</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal: AI -->
<div class="modalMask" id="modalAI">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">AI 助手（账单/分摊/结算）</div>
      <button class="ghost" onclick="closeModal('ai')">关闭</button>
    </div>
    <div class="modalBody">
      <div id="aiMsgs" style="display:flex; flex-direction:column; gap:10px;"></div>

      <div class="hr"></div>

      <label>输入</label>
      <textarea id="aiInput" rows="3" placeholder="例如：帮我检查一下这个结算是否合理？"></textarea>

      <div class="row" style="margin-top:10px; justify-content:space-between">
        <button class="secondary" onclick="seedAiContext()">带入当前账单摘要</button>
        <button onclick="sendAi()">发送</button>
      </div>

      <div class="hint" id="aiHint" style="margin-top:10px"></div>
    </div>
  </div>
</div>
  
<!-- Modal: AI Settings -->
<div class="modalMask" id="modalAISettings">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">AI 设置（仅本机）</div>
      <button class="ghost" onclick="closeModal('aiSettings')">关闭</button>
    </div>
    <div class="modalBody">
      <div class="hint" style="margin-bottom:10px">
        - APP_TOKEN 只保存在你本机浏览器（localStorage），不会同步到 Firebase。<br/>
        - 必须先加入房间并输入 6 位口令，才能调用 AI。
      </div>

      <label>APP_TOKEN（本机保存）</label>
      <input id="aiTokenInput" type="password" placeholder="粘贴你的 APP_TOKEN" />
      <div class="hint" id="aiTokenStatus" style="margin-top:6px"></div>

      <div class="row" style="margin-top:12px">
        <button class="secondary" onclick="saveAiToken()">保存</button>
        <button class="danger" onclick="clearAiToken()">清除</button>
        <button onclick="openModal('ai')">打开 AI 聊天</button>
      </div>
    </div>
  </div>
</div>
  
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js';

  // ===== AI settings =====
  const WORKER_BASE = "https://derfriendtrip.hxy94045.workers.dev";
  const AI_TOKEN_KEY = "aa_ai_app_token_v1";
  let aiHistory = []; // 仅本机，不同步
  
  function getAiToken(){ return localStorage.getItem(AI_TOKEN_KEY) || ""; }
  function setAiToken(t){ localStorage.setItem(AI_TOKEN_KEY, t); }
  function delAiToken(){ localStorage.removeItem(AI_TOKEN_KEY); }
  
  function refreshAiTokenStatus(){
    const el = document.getElementById("aiTokenStatus");
    if(!el) return;
    el.textContent = getAiToken() ? "✅ 已设置 APP_TOKEN（仅本机）" : "⚠️ 未设置 APP_TOKEN（无法调用 AI）";
  }
  
  function saveAiToken(){
    const v = (document.getElementById("aiTokenInput")?.value || "").trim();
    if(!v){ toast("请输入 APP_TOKEN"); return; }
    setAiToken(v);
    document.getElementById("aiTokenInput").value = "";
    refreshAiTokenStatus();
    toast("已保存 APP_TOKEN（仅本机）");
  }
  function clearAiToken(){
    delAiToken();
    refreshAiTokenStatus();
    toast("已清除 APP_TOKEN");
  }
  
  // ===== AI UI =====
  function renderAiMsgs(){
    const box = document.getElementById("aiMsgs");
    if(!box) return;
    box.innerHTML = "";
    if(aiHistory.length === 0){
      box.innerHTML = `<div class="hint">提示：先加入房间并输入口令，再在“协作/分享”里保存 APP_TOKEN，然后就能聊天。</div>`;
      return;
    }
    for(const m of aiHistory){
      const div = document.createElement("div");
      div.className = "ai-bubble " + (m.role === "user" ? "ai-user" : "ai-assistant");
      div.textContent = m.content || "";
      box.appendChild(div);
    }
    // 滚到底
    box.parentElement?.scrollTo?.({ top: 999999, behavior:"smooth" });
  }
  
  function seedAiContext(){
    // 把当前账单的摘要塞到输入框，方便提问
    const txt = document.getElementById("aiInput");
    if(!txt) return;
  
    const { owed, paid, net } = computeTotals();
    const transfers = computeSettlement(net);
  
    const billsBrief = state.bills.slice(0, 8).map(b=>{
      const billDays = daysInclusive(b.start, b.end);
      const ps = (b.participants||[]).length;
      return `- ${b.title} | payer=${b.payer} | $${Number(b.amount||0).toFixed(2)} | ${billDays}天 | ${ps}人`;
    }).join("\n") || "(暂无账单)";
  
    const peopleBrief = state.people.map(p=>{
      const n = net.get(p)||0;
      return `- ${p}: net=$${centsToMoney(n)}`;
    }).join("\n") || "(暂无人员)";
  
    const transBrief = transfers.map(t=>`${t.from} -> ${t.to}: $${centsToMoney(t.amountC)}`).join("\n") || "(无需转账)";
  
    txt.value =
  `我当前的账单/分摊情况如下，请帮我分析/检查/给建议：
  
  账单（最多8条）：
  ${billsBrief}
  
  每人净额（paid-owed）：
  ${peopleBrief}
  
  最少转账方案：
  ${transBrief}
  
  我的问题是：`;
    toast("已带入摘要");
  }
  
  async function callAI(messages){
    if(!roomId){ throw new Error("请先加入房间（roomId 为空）"); }
    if(!/^\d{6}$/.test(passcode||"")){ throw new Error("请先输入 6 位口令加入房间"); }
    const token = getAiToken();
    if(!token) throw new Error("请先在“协作/分享”里保存 APP_TOKEN");
  
    const r = await fetch(`${WORKER_BASE}/ai`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-APP-TOKEN": token,
      },
      body: JSON.stringify({
        roomId,
        passcode,
        messages,
        model: "deepseek-chat",
        temperature: 0.2
      })
    });
  
    const data = await r.json().catch(()=> ({}));
    if(!r.ok){
      throw new Error(data.error || `AI 请求失败（${r.status}）`);
    }
    // DeepSeek 返回结构：choices[0].message.content
    const content = data?.choices?.[0]?.message?.content ?? JSON.stringify(data);
    return content;
  }
  
  async function sendAi(){
    const input = document.getElementById("aiInput");
    const hint = document.getElementById("aiHint");
    const text = (input?.value || "").trim();
    if(!text){ toast("请输入内容"); return; }
  
    try{
      hint.textContent = "AI 正在思考…";
      aiHistory.push({ role:"user", content:text });
      renderAiMsgs();
      input.value = "";
  
      const sys = {
        role: "system",
        content: "你是账单分摊助手。用户使用“人天”分摊，付款人垫付，最后用净额与最少转账方案结算。请用中文回答，尽量给出可执行建议。"
      };
      const msgs = [sys, ...aiHistory.slice(-12)]; // 只带最近对话，避免太长
  
      const ans = await callAI(msgs);
      aiHistory.push({ role:"assistant", content: ans });
      renderAiMsgs();
      hint.textContent = "";
    }catch(e){
      hint.textContent = "";
      toast(e.message || "AI 调用失败");
    }
  }
  
  const ACCENT_PALETTE = [
    ["#12c2ff","#3b5cff"], // cyan->blue
    ["#b24bff","#3b5cff"], // purple->blue
    ["#ff9f2f","#ff3b7a"], // orange->pink
    ["#14b86a","#12c2ff"], // green->cyan
    ["#ff3b7a","#b24bff"], // pink->purple
    ["#3b5cff","#14b86a"], // blue->green
  ];
  
  
  
  function hashStr(s){
    s = String(s||"");
    let h = 2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0);
  }
  function accentForName(name){
    const idx = hashStr(name) % ACCENT_PALETTE.length;
    return ACCENT_PALETTE[idx];
  }

  // ===== Tabs logic =====
  const TAB_KEY = "aa_main_tab_v1";
  let activeTab = localStorage.getItem(TAB_KEY) || "bills";
  
  function setActiveTab(tab){
    activeTab = tab;
    localStorage.setItem(TAB_KEY, tab);
  
    // buttons
    document.querySelectorAll("#mainTabs .tabBtn").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
  
    // panels
    const map = {
      bills: document.getElementById("panelBills"),
      summary: document.getElementById("panelSummary"),
      settle: document.getElementById("panelSettle"),
    };
    Object.entries(map).forEach(([k, el])=>{
      if(el) el.classList.toggle("active", k === tab);
    });
  }
  
  // bind clicks
  document.querySelectorAll("#mainTabs .tabBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
  });
    
  // ========= 1) 把你的 Firebase Web config 粘贴到这里 =========
  const firebaseConfig = {
    apiKey: "AIzaSyDhLRcOhh1eTIGHZ8aSZdBZmPH9PuB_P4k",
    authDomain: "friendtrip-4ead0.firebaseapp.com",
    projectId: "friendtrip-4ead0",
    storageBucket: "friendtrip-4ead0.firebasestorage.app",
    messagingSenderId: "342171915268",
    appId: "1:342171915268:web:98c7133b35bc20c6171151",
    measurementId: "G-8NX6SFYXV8"
  };

  // ========= 基础工具 =========
  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>t.style.display="none", 1800);
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function daysInclusive(startStr, endStr){
    if(!startStr || !endStr) return 0;
    const s = new Date(startStr + "T00:00:00");
    const e = new Date(endStr + "T00:00:00");
    const diff = Math.round((e - s) / (1000*60*60*24));
    return diff >= 0 ? diff + 1 : 0;
  }
  function toCents(x){
    const n = Number(x);
    if(!isFinite(n)) return 0;
    return Math.round(n * 100);
  }
  function centsToMoney(c){
    const sign = c < 0 ? "-" : "";
    c = Math.abs(c);
    const dollars = Math.floor(c / 100);
    const cents = String(c % 100).padStart(2, "0");
    return `${sign}${dollars}.${cents}`;
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function roomIdRandom(){
    const chars = "abcdefghjkmnpqrstuvwxyz23456789";
    let out = "";
    for(let i=0;i<8;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  function getRoomFromUrl(){
    const u = new URL(location.href);
    return u.searchParams.get("room") || "";
  }
  function setRoomToUrl(room){
    const u = new URL(location.href);
    u.searchParams.set("room", room);
    u.hash = "";
    history.replaceState(null, "", u.toString());
  }
  function inviteLink(room){
    const u = new URL(location.href);
    u.searchParams.set("room", room);
    u.hash = "";
    return u.toString();
  }
  function isSixDigits(x){ return /^[0-9]{6}$/.test(String(x||"").trim()); }

  // ========= 加密：AES-GCM + PBKDF2 =========
  function b64urlFromBytes(bytes){
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function bytesFromB64url(b64url){
    let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
    while(b64.length % 4) b64 += "=";
    const bin = atob(b64);
    return Uint8Array.from(bin, c => c.charCodeAt(0));
  }
  async function sha256Hex(str){
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function deriveAesKey(passcode, roomId){
    const salt = new TextEncoder().encode("room:" + roomId);
    const baseKey = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(passcode),
      "PBKDF2",
      false,
      ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      { name:"PBKDF2", salt, iterations: 100000, hash:"SHA-256" },
      baseKey,
      { name:"AES-GCM", length: 256 },
      false,
      ["encrypt","decrypt"]
    );
  }
  async function encryptState(stateObj, passcode, roomId){
    const key = await deriveAesKey(passcode, roomId);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const plaintext = new TextEncoder().encode(JSON.stringify(stateObj));
    const cipherBuf = await crypto.subtle.encrypt({ name:"AES-GCM", iv }, key, plaintext);
    return { iv: b64urlFromBytes(iv), cipher: b64urlFromBytes(new Uint8Array(cipherBuf)) };
  }
  async function decryptState(cipherB64url, ivB64url, passcode, roomId){
    const key = await deriveAesKey(passcode, roomId);
    const iv = bytesFromB64url(ivB64url);
    const cipherBytes = bytesFromB64url(cipherB64url);
    const plainBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, cipherBytes);
    const json = new TextDecoder().decode(new Uint8Array(plainBuf));
    return JSON.parse(json);
  }

  // ========= 本地状态 =========
  const STORAGE_KEY = "aa_split_state_secure_v1";
  const PASS_STORE_KEY = "aa_room_pass_secure_v1"; // localStorage: { [roomId]: "123456" }
  let editingBillId = null;
  let state = { people: [], bills: [] };
  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const obj = JSON.parse(raw);
        if(obj && Array.isArray(obj.people) && Array.isArray(obj.bills)) state = obj;
      }
    }catch(e){}
  }
  function saveLocal(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function storePass(roomId, pass){
    try{
      const raw = localStorage.getItem(PASS_STORE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      obj[roomId] = pass;
      localStorage.setItem(PASS_STORE_KEY, JSON.stringify(obj));
    }catch(e){}
  }
  function getStoredPass(roomId){
    try{
      const raw = localStorage.getItem(PASS_STORE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return obj[roomId] || "";
    }catch(e){ return ""; }
  }

  // ========= 弹窗 =========
  function openModal(which){
    if(which==="person") $("modalPerson").style.display="flex";
    if(which==="ai"){
      document.getElementById("modalAI").style.display="flex";
      refreshAiTokenStatus();
      renderAiMsgs();
    }
    if(which==="aiSettings"){
      document.getElementById("modalAISettings").style.display="flex";
      refreshAiTokenStatus();
    }
    if(which==="bill"){
      if(state.people.length===0){ toast("先添加至少 1 个人"); openModal("person"); return; }
      editingBillId = null; // ✅ 默认进入创建模式
      seedBillForm();
      // 标题/按钮文字
      document.querySelector("#modalBill .modalTitle").textContent = "添加账单";
      $("billSaveBtn").textContent = "创建";
      $("modalBill").style.display="flex";
    }
    if(which==="share"){
      refreshCollabUI();

      // ✅ 自动把 URL 的 room 填入 joinRoomInput
      const urlRoom = getRoomFromUrl();
      if(urlRoom){
        $("joinRoomInput").value = urlRoom;
        // 如果本机记住了口令，也自动填（可删）
        const sp = getStoredPass(urlRoom);
        if(sp) $("joinPassInput").value = sp;
        setTimeout(()=> $("joinPassInput").focus(), 0);
      }

      $("modalShare").style.display="flex";
    }
  }
  function openAiEntry(){
  // 必须先加入房间 + 有 6 位口令
  if(!roomId || !/^\d{6}$/.test(passcode||"")){
    toast("请先在“协作”加入房间并输入 6 位口令");
    openModal("share");
    return;
  }
  // 没 token：先去设置
  if(!getAiToken()){
    openModal("aiSettings");
    return;
  }
  // 有 token：直接进聊天
  openModal("ai");
}
window.openAiEntry = openAiEntry;

  function closeModal(which){
    if(which==="person") $("modalPerson").style.display="none";
    if(which==="ai") document.getElementById("modalAI").style.display="none";
    if(which==="aiSettings") document.getElementById("modalAISettings").style.display="none";
    if(which==="bill"){
      // ✅ 清理编辑状态（新增）
      editingBillId = null;
      document.querySelector("#modalBill .modalTitle").textContent = "添加账单";
      const btn = document.getElementById("billSaveBtn");
      if(btn) btn.textContent = "创建";
  
      $("modalBill").style.display="none";
    }
  
    if(which==="share") $("modalShare").style.display="none";
  }


  // ========= 人员 =========
  function addPerson(){
    const name = $("personName").value.trim();
    if(!name) return;
    if(state.people.includes(name)){ toast("该人员已存在"); return; }
    state.people.push(name);
    $("personName").value="";
    touchAndRender("已添加人员");
    closeModal("person");
  }

  function renderPeople(){
    const box = $("peoplePills");
    box.innerHTML="";
    if(state.people.length===0){
      box.innerHTML = `<div class="hint">还没有人员，点底部“+人”添加。</div>`;
      return;
    }
    state.people.forEach(p=>{
      const el=document.createElement("span");
      el.className="pill";
      el.innerHTML = `<b>${escapeHtml(p)}</b><span class="muted">人员</span><span class="x">✕</span>`;
      el.querySelector(".x").addEventListener("click", ()=>{
        state.people = state.people.filter(x=>x!==p);
        state.bills.forEach(b=>{
          b.participants = (b.participants||[]).filter(pp=>pp.name!==p);
          if(b.payer===p) b.payer="";
        });
        touchAndRender("已删除人员");
      });
      box.appendChild(el);
    });
  }

  // ========= 账单表单 =========
  function seedBillForm(){
    const today=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const d=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
    if(!$("billStart").value) $("billStart").value=d;
    if(!$("billEnd").value) $("billEnd").value=d;

    const payer=$("billPayer");
    payer.innerHTML="";
    state.people.forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p; opt.textContent=p;
      payer.appendChild(opt);
    });

    const checks=$("billParticipantsChecks");
    checks.innerHTML="";
    state.people.forEach(p=>{
      const div=document.createElement("label");
      div.className="checkItem";
      div.innerHTML = `<input type="checkbox" value="${escapeHtml(p)}" checked /> <span style="font-weight:900">${escapeHtml(p)}</span>`;
      checks.appendChild(div);
    });

    function updateDays(){
      const dd = daysInclusive($("billStart").value, $("billEnd").value);
      $("billDays").value = dd ? `${dd} 天` : "";
    }
    $("billStart").onchange=updateDays;
    $("billEnd").onchange=updateDays;
    updateDays();
  }

  function createBill(){
    const title=$("billTitle").value.trim();
    const amount=Number($("billAmount").value);
    const start=$("billStart").value;
    const end=$("billEnd").value;
    const payer=$("billPayer").value;

    const billDays=daysInclusive(start,end);
    const selected=[...$("billParticipantsChecks").querySelectorAll("input[type=checkbox]:checked")].map(x=>x.value);

    if(!title){ toast("请填账单名称"); return; }
    if(!(amount>=0)){ toast("请填正确金额"); return; }
    if(!start||!end||billDays<=0){ toast("日期范围不对"); return; }
    if(!payer){ toast("请选择付款人"); return; }
    if(selected.length===0){ toast("至少选择 1 个参与人"); return; }

    const participantsSelected = selected;
    
    // ✅ 编辑模式：更新原账单（尽量保留每个人已设置的 days）
    if(editingBillId){
      const b = state.bills.find(x=>x.id===editingBillId);
      if(!b){ toast("编辑失败：找不到账单"); return; }
    
      b.title = title;
      b.amount = amount;
      b.start = start;
      b.end = end;
      b.payer = payer;
    
      const oldMap = new Map((b.participants||[]).map(p=>[p.name, p.days]));
      b.participants = participantsSelected.map(name=>({
        name,
        // 原来就存在：保留用户改过的 days；新加入：默认等于账单天数
        days: Math.max(0, Math.floor(Number(oldMap.get(name) ?? billDays) || 0))
      }));
    
      editingBillId = null;
      $("billTitle").value=""; $("billAmount").value="";
      touchAndRender("已保存修改");
      closeModal("bill");
      return;
    }
    
    // ✅ 创建模式：新建账单
    const participants = participantsSelected.map(name=>({name, days: billDays}));
    state.bills.unshift({ id: uid(), title, amount, start, end, payer, participants });
    
    $("billTitle").value=""; $("billAmount").value="";
    touchAndRender("已创建账单");
    closeModal("bill");

  }
  
  function openEditBill(billId){
    const b = state.bills.find(x=>x.id===billId);
    if(!b){ toast("找不到该账单"); return; }
  
    editingBillId = billId;
  
    // 先用现有逻辑生成表单（人名、checkbox、天数监听等）
    seedBillForm();
  
    // 回填字段
    $("billTitle").value = b.title || "";
    $("billAmount").value = (Number(b.amount)||0).toFixed(2).replace(/\.00$/,""); // 1200.00 => 1200
    $("billStart").value = b.start || "";
    $("billEnd").value = b.end || "";
    $("billPayer").value = b.payer || (state.people[0]||"");
  
    // 触发天数刷新
    $("billStart").dispatchEvent(new Event("change"));
    $("billEnd").dispatchEvent(new Event("change"));
  
    // 回填参与人勾选
    const selected = new Set((b.participants||[]).map(p=>p.name));
    [...$("billParticipantsChecks").querySelectorAll('input[type=checkbox]')].forEach(chk=>{
      chk.checked = selected.has(chk.value);
    });
  
    // 改标题/按钮
    document.querySelector("#modalBill .modalTitle").textContent = "编辑账单";
    $("billSaveBtn").textContent = "保存修改";
  
    $("modalBill").style.display="flex";
  }

  // ========= 分摊/结算 =========
  function computeAllocCents(bill){
    const amountC=toCents(bill.amount);
    const ps=bill.participants||[];
    const totalPersonDays = ps.reduce((s,p)=>s+(Number(p.days)||0),0);
    if(amountC<=0 || totalPersonDays<=0 || ps.length===0){
      return { amountC, totalPersonDays, alloc: ps.map(p=>({name:p.name, days:Number(p.days)||0, shareC:0})) };
    }
    const items = ps.map((p,idx)=>{
      const d=Math.max(0, Math.floor(Number(p.days)||0));
      const exact = amountC * (d/totalPersonDays);
      const floorC=Math.floor(exact);
      const rem=exact-floorC;
      return { idx, name:p.name, days:d, floorC, rem };
    });
    let sumFloor=items.reduce((s,x)=>s+x.floorC,0);
    let remaining=amountC-sumFloor;
    items.sort((a,b)=>b.rem-a.rem);
    for(let i=0;i<items.length && remaining>0;i++){
      items[i].floorC += 1; remaining -= 1;
    }
    items.sort((a,b)=>a.idx-b.idx);
    return { amountC, totalPersonDays, alloc: items.map(x=>({name:x.name, days:x.days, shareC:x.floorC})) };
  }

  function computeTotals(){
    const owed=new Map(), paid=new Map();
    state.people.forEach(p=>{ owed.set(p,0); paid.set(p,0); });
    for(const b of state.bills){
      const { amountC, alloc } = computeAllocCents(b);
      if(b.payer) paid.set(b.payer, (paid.get(b.payer)||0) + amountC);
      for(const a of alloc) owed.set(a.name, (owed.get(a.name)||0) + a.shareC);
    }
    const net=new Map();
    const all=new Set([...owed.keys(), ...paid.keys()]);
    for(const name of all) net.set(name, (paid.get(name)||0) - (owed.get(name)||0));
    return { owed, paid, net };
  }

  function computeSettlement(netMap){
    const creditors=[], debtors=[];
    for(const [name,v] of netMap.entries()){
      if(v>0) creditors.push({name, amt:v});
      else if(v<0) debtors.push({name, amt:-v});
    }
    creditors.sort((a,b)=>b.amt-a.amt);
    debtors.sort((a,b)=>b.amt-a.amt);
    const transfers=[];
    let i=0,j=0;
    while(i<debtors.length && j<creditors.length){
      const d=debtors[i], c=creditors[j];
      const x=Math.min(d.amt,c.amt);
      if(x>0){
        transfers.push({from:d.name,to:c.name,amountC:x});
        d.amt-=x; c.amt-=x;
      }
      if(d.amt===0) i++;
      if(c.amt===0) j++;
    }
    return transfers;
  }
  const EXPAND_KEY = "aa_bill_expand_v1";
  const isMobile = () => window.matchMedia("(max-width: 640px)").matches;
  
  let expandedBills = new Set();
  try{
    expandedBills = new Set(JSON.parse(localStorage.getItem(EXPAND_KEY) || "[]"));
  }catch(e){ expandedBills = new Set(); }
  
  function persistExpanded(){
    localStorage.setItem(EXPAND_KEY, JSON.stringify([...expandedBills]));
  }
  
  const BILLS_VIEW_KEY = "aa_bills_view_compact_v1";
  let billsCompact = false;
  try{
    billsCompact = JSON.parse(localStorage.getItem(BILLS_VIEW_KEY) || "false");
  }catch(e){ billsCompact = false; }
  
  function persistBillsCompact(){
    localStorage.setItem(BILLS_VIEW_KEY, JSON.stringify(!!billsCompact));
  }

  const FILTER_KEY = "aa_bill_filter_v1";
  let billFilter = { payer:"", from:"", to:"" };
  try{ billFilter = JSON.parse(localStorage.getItem(FILTER_KEY) || "{}"); }catch(e){}
  billFilter = { payer: billFilter.payer||"", from: billFilter.from||"", to: billFilter.to||"" };
  
  function saveBillFilter(){
    localStorage.setItem(FILTER_KEY, JSON.stringify(billFilter));
  }
  
  function date0(s){ return s ? new Date(s + "T00:00:00") : null; }
  
  // 交集判断：bill[bs,be] 与 filter[fs,fe] 有交集
  function inRangeOverlap(b){
    const bs = date0(b.start), be = date0(b.end);
    const fs = date0(billFilter.from), fe = date0(billFilter.to);
    if(!bs || !be) return true;
    if(fs && be < fs) return false;
    if(fe && bs > fe) return false;
    return true;
  }
  
  function getFilteredBills(){
    return state.bills.filter(b=>{
      if(billFilter.payer && b.payer !== billFilter.payer) return false;
      if(!inRangeOverlap(b)) return false;
      return true;
    });
  }
  
function syncFilterUI(){
  const sel = document.getElementById("filterPayer");
  const f1  = document.getElementById("filterFrom");
  const f2  = document.getElementById("filterTo");
  const hint = document.getElementById("filterRangeHint");

  if(!sel) return;

  // 1) 付款人下拉：只列出“账单里出现过的付款人”
  const payerSet = new Set(
    state.bills.map(b => String(b.payer || "").trim()).filter(Boolean)
  );
  const payers = Array.from(payerSet).sort((a,b)=>a.localeCompare(b,"zh"));

  // 若当前筛选 payer 不存在了，自动清空
  if(billFilter.payer && !payerSet.has(billFilter.payer)){
    billFilter.payer = "";
    saveBillFilter();
  }

  sel.innerHTML =
    `<option value="">全部付款人</option>` +
    payers.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");

  sel.value = billFilter.payer || "";

  // 2) 日期范围：只给“有值范围”（自动 min/max + 提示）
  const dates = state.bills
    .filter(b => b.start && b.end)
    .map(b => ({ s: b.start, e: b.end }));

  let minD = "", maxD = "";
  for(const d of dates){
    if(!minD || d.s < minD) minD = d.s;
    if(!maxD || d.e > maxD) maxD = d.e;
  }

  if(f1 && f2){
    if(minD && maxD){
      f1.min = minD; f1.max = maxD;
      f2.min = minD; f2.max = maxD;
      if(hint) hint.textContent = `可筛选日期范围：${minD} ~ ${maxD}`;
    }else{
      f1.min = ""; f1.max = "";
      f2.min = ""; f2.max = "";
      if(hint) hint.textContent = "暂无可用日期范围（先添加带日期的账单）";
    }

    // 回填筛选值
    f1.value = billFilter.from || "";
    f2.value = billFilter.to || "";

    // 如果筛选日期超出范围，自动清空
    if(minD && maxD){
      let changed = false;
      if(billFilter.from && (billFilter.from < minD || billFilter.from > maxD)){
        billFilter.from = ""; changed = true;
      }
      if(billFilter.to && (billFilter.to < minD || billFilter.to > maxD)){
        billFilter.to = ""; changed = true;
      }
      if(changed){
        saveBillFilter();
        f1.value = billFilter.from || "";
        f2.value = billFilter.to || "";
      }
    }
  }
}

  
  function bindFilterEventsOnce(){
    const sel = document.getElementById("filterPayer");
    const f1 = document.getElementById("filterFrom");
    const f2 = document.getElementById("filterTo");
    const clr = document.getElementById("btnFilterClear");
    if(!sel || sel.dataset.bound) return; // 防重复绑定
    sel.dataset.bound = "1";
  
    sel.addEventListener("change", ()=>{
      billFilter.payer = sel.value;
      saveBillFilter();
      renderAll();
    });
    f1.addEventListener("change", ()=>{
      billFilter.from = f1.value || "";
      saveBillFilter();
      renderAll();
    });
    f2.addEventListener("change", ()=>{
      billFilter.to = f2.value || "";
      saveBillFilter();
      renderAll();
    });
    clr?.addEventListener("click", ()=>{
      billFilter = { payer:"", from:"", to:"" };
      saveBillFilter();
      syncFilterUI();
      toast("已清空筛选");
      renderAll();
    });
  }  
  function renderBills(){
    const box=$("billsContainer");
    box.innerHTML="";
    const bills = getFilteredBills();
    if(bills.length===0){

      if(state.bills.length===0){
        box.innerHTML=`<div class="hint">还没有账单，点底部“+账”添加。</div>`;
      }else{
        box.innerHTML=`<div class="hint">没有符合筛选条件的账单。</div>`;
      }
      return;
    }
      // ✅ 列表折叠视图：只显示 付款人/金额/人数/天数（点击可展开到卡片视图并定位）
    if(billsCompact){
      const table = document.createElement("table");
      table.className = "bill-table";
      table.innerHTML = `
        <thead>
          <tr>
            <th>付款人</th>
            <th class="right">金额</th>
            <th class="right">人数</th>
            <th class="right">天数</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tb = table.querySelector("tbody");
  
      bills.forEach(b=>{
        const billDays = daysInclusive(b.start, b.end);
        const amountC = toCents(b.amount);
        const peopleCount = (b.participants||[]).length;
  
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.innerHTML = `
          <td>
            <div style="font-weight:900">${escapeHtml(b.payer || "")}</div>
            <div class="small muted">${escapeHtml(b.title||"未命名账单")}</div>
          </td>
          <td class="right mono">$${centsToMoney(amountC)}</td>
          <td class="right mono">${peopleCount}</td>
          <td class="right mono">${billDays}</td>
        `;
  
        // 点击行：切回卡片视图，并让该账单默认展开 + 滚动定位
        tr.addEventListener("click", ()=>{
          billsCompact = false;
          persistBillsCompact();
          renderAll();
          setTimeout(()=>{
            document.getElementById(`bill-${b.id}`)?.scrollIntoView({behavior:"smooth", block:"start"});
          }, 0);
        });
  
        tb.appendChild(tr);
      });
  
      box.appendChild(table);
      return;
    }
    bills.forEach(b=>{
      const billDays=daysInclusive(b.start,b.end);
      const { amountC, totalPersonDays, alloc } = computeAllocCents(b);

    const card=document.createElement("div");
    card.className="card billCard";
    card.style.marginBottom="12px";
    card.id = `bill-${b.id}`;
    
    // ✅ 按付款人上色（没有付款人就用标题）
    const [a1,a2] = accentForName(b.payer || b.title || "bill");
    card.style.setProperty("--accent1", a1);
    card.style.setProperty("--accent2", a2);

    const payerOptions = state.people.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    const isOpen = expandedBills.has(b.id); // ✅ 默认不自动展开


      card.innerHTML = `
        <div class="bill-topline">
          <div>
            <div class="billCardHeaderGlow">
              <div style="font-weight:950">${escapeHtml(b.title||"未命名账单")}</div>
              <div class="small muted" style="margin-top:4px">
                金额：<span class="mono">$${centsToMoney(amountC)}</span> ·
                日期：<span class="mono">${escapeHtml(b.start)}</span> ~ <span class="mono">${escapeHtml(b.end)}</span>（${billDays}天） ·
                总人天：<span class="mono">${totalPersonDays}</span>
              </div>
        
              <div class="row" style="margin-top:8px">
                <span class="badge">付款人</span>
                <select data-role="payer" style="min-width:160px">${payerOptions}</select>
                <button class="secondary ghost" data-act="setAll">一键全程</button>
              </div>
            </div>
          </div>
      
          <div class="bill-actions">
            <button class="secondary ghost bill-toggle" data-act="toggle">${isOpen ? "收起" : "展开"}</button>
            <button class="secondary ghost" data-act="edit">编辑</button>
            <button class="secondary ghost" data-act="dup">复制</button>
            <button class="danger" data-act="del">删除</button>
          </div>
        </div>
      
        <div class="bill-body ${isOpen ? "open" : ""}" data-role="body">
          <div class="hr"></div>
      
          <table class="bill-table">
            <thead>
              <tr>
                <th>参与人</th>
                <th class="right">参与天数</th>
                <th class="right">应付</th>
              </tr>
            </thead>
            <tbody data-role="tb"></tbody>
          </table>
        </div>
      `;


      const payerSel=card.querySelector('[data-role="payer"]');
      payerSel.value=b.payer || state.people[0] || "";
      payerSel.addEventListener("change", ()=>{ b.payer=payerSel.value; touchAndRender(); });

      card.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        state.bills = state.bills.filter(x=>x.id!==b.id);
        touchAndRender("已删除账单");
      });
      card.querySelector('[data-act="dup"]').addEventListener("click", ()=>{
        const copy=JSON.parse(JSON.stringify(b));
        copy.id=uid(); copy.title=(copy.title||"账单")+"（复制）";
        state.bills.unshift(copy);
        touchAndRender("已复制");
      });
      card.querySelector('[data-act="setAll"]').addEventListener("click", ()=>{
        (b.participants||[]).forEach(pp=>pp.days=billDays);
        touchAndRender("已设置全程");
      });
      card.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        openEditBill(b.id);
      });

      // ✅ 折叠/展开（新增）
      const bodyBox = card.querySelector('[data-role="body"]');
      const toggleBtn = card.querySelector('[data-act="toggle"]');
      
      toggleBtn.addEventListener("click", ()=>{
        const willOpen = !bodyBox.classList.contains("open");
        bodyBox.classList.toggle("open", willOpen);
        toggleBtn.textContent = willOpen ? "收起" : "展开";
      
        if(willOpen) expandedBills.add(b.id);
        else expandedBills.delete(b.id);
        persistExpanded();
      });

      const tb=card.querySelector('[data-role="tb"]');
      (b.participants||[]).forEach(pp=>{
        const shareC = alloc.find(a=>a.name===pp.name)?.shareC ?? 0;
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td style="font-weight:900">${escapeHtml(pp.name)}</td>
          <td class="right">
            <input type="number" min="0" step="1"
              value="${Math.max(0, Math.floor(Number(pp.days)||0))}"
              class="bill-days-input" />
            <div class="bill-suggest">建议：${billDays}</div>
          </td>
          <td class="right mono">$${centsToMoney(shareC)}</td>
        `;
        const inp=tr.querySelector("input");
        inp.addEventListener("input", ()=>{
          pp.days = Math.max(0, Math.floor(Number(inp.value)||0));
          touchAndRender();
        });
        tb.appendChild(tr);
      });

      box.appendChild(card);
    });
  }

  function renderSummary(){
    const { owed, paid, net } = computeTotals();
    const names=Array.from(new Set([...state.people, ...net.keys()]));
    const rows=names.map(name=>({
      name, owedC:owed.get(name)||0, paidC:paid.get(name)||0, netC:net.get(name)||0
    })).sort((a,b)=>b.netC-a.netC);

    const body=$("summaryBody");
    body.innerHTML="";
    if(rows.length===0){
      body.innerHTML=`<tr><td class="muted" colspan="4">暂无数据</td></tr>`;
    }else{
      rows.forEach(r=>{
        const cls = r.netC>0 ? "ok" : (r.netC<0 ? "no" : "muted");
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td style="font-weight:900">${escapeHtml(r.name)}</td>
          <td class="right mono">$${centsToMoney(r.owedC)}</td>
          <td class="right mono">$${centsToMoney(r.paidC)}</td>
          <td class="right mono ${cls}">$${centsToMoney(r.netC)}</td>
        `;
        body.appendChild(tr);
      });
    }

    const transfers=computeSettlement(net);
    const sb=$("settleBody");
    sb.innerHTML="";
    if(transfers.length===0){
      sb.innerHTML=`<tr><td class="muted" colspan="3">暂无需要转账</td></tr>`;
    }else{
      transfers.forEach(t=>{
        const tr=document.createElement("tr");
          tr.innerHTML=`
            <td style="font-weight:900">${escapeHtml(t.from)}</td>
            <td style="font-weight:900">${escapeHtml(t.to)}</td>
            <td class="right mono">$${centsToMoney(t.amountC)}</td>
          `;
        sb.appendChild(tr);
      });
    }
  }

  function renderAll(){
    renderPeople();
    renderBills();
    renderSummary();
    syncFilterUI();
    bindFilterEventsOnce();
  }

  // ========= JSON 备份 =========
  function exportJSONToBox(){ $("jsonBox").value = JSON.stringify(state,null,2); toast("已导出到文本框"); }
  function importJSONFromBox(){
    try{
      const txt=$("jsonBox").value.trim();
      if(!txt){ toast("请先粘贴 JSON"); return; }
      const obj=JSON.parse(txt);
      if(!obj || !Array.isArray(obj.people) || !Array.isArray(obj.bills)){ toast("JSON结构不对"); return; }
      state.people=obj.people.map(String).filter(Boolean);
      state.bills=obj.bills.map(b=>({
        id:b.id||uid(), title:String(b.title||"账单"), amount:Number(b.amount)||0,
        start:b.start||"", end:b.end||"", payer:String(b.payer||""),
        participants:Array.isArray(b.participants)? b.participants.map(p=>({
          name:String(p.name||""), days:Math.max(0, Math.floor(Number(p.days)||0))
        })).filter(p=>p.name):[]
      }));
      touchAndRender("导入成功");
    }catch(e){ toast("导入失败："+e.message); }
  }
  function exportJSON(){ openModal("share"); exportJSONToBox(); }
  function clearAll(){
    if(!confirm("确认清空全部人员和账单？")) return;
    state={people:[], bills:[]};
    touchAndRender("已清空");
  }

  // ========= Firebase 真协作（加密） =========
  let app=null, auth=null, db=null;
  let clientId = localStorage.getItem("aa_client_id") || uid();
  localStorage.setItem("aa_client_id", clientId);

  let roomId="";
  let passcode="";
  let passHash="";
  let unsubRoom=null;

  let localVersion=0;
  let lastRemoteVersion=0;
  let pushing=false;
  let pushTimer=null;

  function setSyncBadge(text){ $("syncBadge").textContent=text; }
  function refreshCollabUI(){
    $("roomIdBox").value = roomId || "";
    $("inviteLinkBox").value = roomId ? inviteLink(roomId) : "";
  }

  async function ensureFirebase(){
    if(app) return;
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }
  async function ensureAuth(){
    await signInAnonymously(auth);
    await new Promise((resolve)=> {
      const off = onAuthStateChanged(auth, (u)=>{ if(u){ off(); resolve(); } });
    });
  }

  function friendlyErr(e){
    const msg = String(e?.message || e || "unknown");
    if(msg.includes("auth/unauthorized-domain")) return "Firebase 未授权域名：请在 Firebase Auth 里添加 hxyder.github.io";
    if(msg.includes("permission-denied")) return "Firestore Rules 拒绝写入：检查 Rules 是否按要求发布";
    return msg;
  }

  async function connectRoom(room, pass){
    try{
      if(!room){ toast("room 不能为空"); return false; }
      if(!isSixDigits(pass)){ toast("口令必须是 6 位数字"); return false; }

      await ensureFirebase();
      await ensureAuth();

      roomId = room;
      passcode = pass;
      passHash = await sha256Hex(passcode);

      setRoomToUrl(roomId);
      refreshCollabUI();
      setSyncBadge(`连接中：room=${roomId}`);

      storePass(roomId, passcode);

      if(unsubRoom) unsubRoom();

      const roomRef = doc(db, "rooms", roomId);
      const snap = await getDoc(roomRef);

      if(snap.exists()){
        const data = snap.data();
        if(String(data.passHash||"") !== passHash){
          setSyncBadge("口令错误：无法加入");
          toast("口令错误：无法加入该房间");
          roomId=""; passcode=""; passHash="";
          refreshCollabUI();
          return false;
        }

        try{
          if(data.cipher && data.iv){
            const remoteState = await decryptState(data.cipher, data.iv, passcode, roomId);
            state = remoteState;
            saveLocal();
            renderAll();
          }
        }catch(e){
          setSyncBadge("解密失败：口令不对或数据损坏");
          toast("解密失败：口令不对或数据损坏");
          roomId=""; passcode=""; passHash="";
          refreshCollabUI();
          return false;
        }
      }else{
        // 新房间：用本地 state 初始化
        const enc = await encryptState(state, passcode, roomId);
        await setDoc(roomRef, {
          passHash,
          cipher: enc.cipher,
          iv: enc.iv,
          version: localVersion,
          updatedAt: serverTimestamp(),
          updatedBy: clientId,
        }, { merge:false });
      }

      // 监听远端变更
      unsubRoom = onSnapshot(roomRef, async (s)=>{
        const data = s.data();
        if(!data) return;
        if(String(data.passHash||"") !== passHash) return;

        const v = Number(data.version || 0);
        const by = String(data.updatedBy || "");
        if(!data.cipher || !data.iv) return;

        if(by === clientId){
          lastRemoteVersion = Math.max(lastRemoteVersion, v);
          return;
        }

        if(v > lastRemoteVersion && v >= localVersion){
          try{
            const remoteState = await decryptState(data.cipher, data.iv, passcode, roomId);
            lastRemoteVersion = v;
            localVersion = v;
            state = remoteState;
            saveLocal();
            renderAll();
            setSyncBadge(`已同步：room=${roomId}`);
          }catch(e){
            setSyncBadge("同步到的内容无法解密（口令不匹配？）");
          }
        }
      });

      setSyncBadge(`已同步：room=${roomId}`);
      return true;

    }catch(e){
      const m = friendlyErr(e);
      setSyncBadge("连接失败：" + m);
      toast("连接失败：" + m);
      console.error(e);
      return false;
    }
  }

  function schedulePush(){
    if(!roomId || !db || !passcode) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(pushNow, 650);
  }

  async function pushNow(){
    if(!roomId || !db || !passcode) return;
    if(pushing) return;
    pushing = true;

    try{
      const roomRef = doc(db, "rooms", roomId);
      const enc = await encryptState(state, passcode, roomId);

      await setDoc(roomRef, {
        passHash,
        cipher: enc.cipher,
        iv: enc.iv,
        version: localVersion,
        updatedAt: serverTimestamp(),
        updatedBy: clientId,
      }, { merge:true });

      setSyncBadge(`已同步：room=${roomId}`);
    }catch(e){
      const m = friendlyErr(e);
      setSyncBadge("同步失败：" + m);
      toast("同步失败：" + m);
      console.error(e);
    }finally{
      pushing = false;
    }
  }

  function touchAndRender(msg){
    localVersion += 1;
    saveLocal();
    renderAll();
    if(msg) toast(msg);
    schedulePush();
  }

  async function createNewRoom(){
    const pass = $("createPassInput").value.trim();
    if(!isSixDigits(pass)){ toast("请在“新房间口令”里输入 6 位数字"); return; }
    const rid = roomIdRandom();
    const ok = await connectRoom(rid, pass);
    if(ok){
      refreshCollabUI();
      toast("创建成功（已进入房间）");
      closeModal("share");
    }
  }

  async function joinRoom(){
    const rid = $("joinRoomInput").value.trim();
    const pass = $("joinPassInput").value.trim();
    if(!rid){ toast("请输入 room"); return; }
    if(!isSixDigits(pass)){ toast("口令必须是 6 位数字"); return; }

    const ok = await connectRoom(rid, pass);
    if(ok){
      $("joinRoomInput").value="";
      $("joinPassInput").value="";
      refreshCollabUI();
      toast("进入成功");
      closeModal("share");
    }
  }

  async function copyInviteLink(){
    if(!roomId){ toast("还没进入房间"); return; }
    const link = inviteLink(roomId);
    try{
      await navigator.clipboard.writeText(link);
      toast("已复制邀请链接（口令请另发）");
    }catch(e){
      $("inviteLinkBox").focus();
      $("inviteLinkBox").select();
      toast("复制失败：请手动复制");
    }
  }

  // ========= 全局绑定（解决“点按钮没反应”） =========
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.addPerson = addPerson;
  window.openEditBill = openEditBill;
  window.createBill = createBill;
  window.exportJSON = exportJSON;
  window.exportJSONToBox = exportJSONToBox;
  window.importJSONFromBox = importJSONFromBox;
  window.clearAll = clearAll;

  window.createNewRoom = createNewRoom;
  window.joinRoom = joinRoom;
  window.copyInviteLink = copyInviteLink;
  window.saveAiToken = saveAiToken;
  window.clearAiToken = clearAiToken;
  window.seedAiContext = seedAiContext;
  window.sendAi = sendAi;
  window.openAiEntry = openAiEntry;
  // ========= 初始化 =========
  loadLocal();
  renderAll();
  setActiveTab(activeTab);
  document.getElementById("btnBillsCompact")?.addEventListener("click", ()=>{
    billsCompact = true;
    persistBillsCompact();
    toast("已折叠为列表视图");
    renderAll();
  });
  
  document.getElementById("btnBillsExpand")?.addEventListener("click", ()=>{
    billsCompact = false;
    persistBillsCompact();
    toast("已展开为卡片视图");
    renderAll();
  });

  // URL 带 room：自动打开分享弹窗并填好 room
  const urlRoom = getRoomFromUrl();
  if(urlRoom){
    setSyncBadge("检测到房间号：请输入口令加入");
    // 自动弹出协作窗口，直接让用户输口令
    setTimeout(()=> openModal("share"), 250);

    // 如果本机记住口令，尝试自动加入（同一设备）
    const sp = getStoredPass(urlRoom);
    if(sp && isSixDigits(sp)){
      setTimeout(async ()=>{
        const ok = await connectRoom(urlRoom, sp);
        if(ok){ toast("已自动重连成功"); }
      }, 600);
    }
  }else{
    setSyncBadge("离线：仅本机保存（点“协作/分享”创建/加入）");
  }

  refreshCollabUI();
  refreshAiTokenStatus();

</script>
</body>
</html>














